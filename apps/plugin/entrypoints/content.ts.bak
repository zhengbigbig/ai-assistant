import { defineContentScript } from 'wxt/sandbox';

// å®šä¹‰å†…å®¹è„šæœ¬
export default defineContentScript({
  matches: ['http://*/*', 'https://*/*'], // åŒ¹é…æ‰€æœ‰ç½‘é¡µ
  runAt: 'document_end', // åœ¨ DOM åŠ è½½å®Œæˆåè¿è¡Œ
  main() {
    console.log('AI Assistant content script loaded');

    // æ·»åŠ åˆ’è¯å¤„ç†
    setupTextSelectionHandler();

    // åˆ›å»ºæˆªå›¾ç›¸å…³çš„DOMå…ƒç´  - ä½†ä¸ç«‹å³æ˜¾ç¤º
    createScreenshotElements();

    // ç›‘å¬æ¥è‡ªåå°çš„æ¶ˆæ¯
    chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
      console.log('Content script received message:', message);

      if (message.action === 'getSelectedText') {
        // è·å–å¹¶è¿”å›å½“å‰é€‰ä¸­çš„æ–‡æœ¬
        const selectedText = window.getSelection()?.toString() || '';
        sendResponse({ text: selectedText });
      } else if (message.action === 'startAreaScreenshot') {
        // ç›´æ¥å¼€å§‹åŒºåŸŸæˆªå›¾æ¨¡å¼
        console.log('Starting area screenshot mode');
        startAreaScreenshot();
        sendResponse({ success: true });
      } else if (message.action === 'startExtendedAreaScreenshot') {
        // ç›´æ¥å¼€å§‹æ‰©å±•åŒºåŸŸæˆªå›¾æ¨¡å¼ï¼Œä¸å†æ˜¾ç¤ºé€‰æ‹©æŒ‰é’®
        console.log('Starting extended area screenshot mode');
        startExtendedAreaScreenshot();
        sendResponse({ success: true });
      }
      return true;
    });

    // æ‰‹åŠ¨æ³¨å†Œè°ƒè¯•å¿«æ·é”®
    document.addEventListener('keydown', (e) => {
      // Alt+Shift+S: è§¦å‘æ‰©å±•åŒºåŸŸæˆªå›¾æ¨¡å¼ï¼ˆç”¨äºè°ƒè¯•ï¼‰
      if (e.altKey && e.shiftKey && e.key === 'S') {
        console.log('Debug: Manually triggering extended area screenshot');
        startExtendedAreaScreenshot();
      }
    });
  },
});

// æˆªå›¾ç›¸å…³å˜é‡
let isSelecting = false;
let startX = 0;
let startY = 0;
let endX = 0;
let endY = 0;
let selectionBox: HTMLElement | null = null;
let screenshotOverlay: HTMLElement | null = null;
let screenshotControls: HTMLElement | null = null;
// æ»šåŠ¨æˆªå›¾ç›¸å…³å˜é‡
let isScrollCapturing = false;
let scrollCaptureCanvas: HTMLCanvasElement | null = null;
let scrollCaptureContext: CanvasRenderingContext2D | null = null;
let scrollCaptureImages: string[] = [];
let currentScrollPosition = 0;
let totalScrollHeight = 0;
let viewportHeight = 0;
let scrollCaptureProgress: HTMLElement | null = null;
// æ‹–æ‹½æˆªå›¾ç›¸å…³å˜é‡
const isDragScrollCapturing = false;
const dragScrollRect: DOMRect | null = null;
const dragScrollControl: HTMLElement | null = null;

// æ·»åŠ æ‹–æ‹½å’Œæ»šåŠ¨ç›¸å…³å˜é‡
let isDragging = false;
let mouseStartY = 0;
let mouseCurrentY = 0;
let scrollStartY = 0;
const autoScrollInterval: number | null = null;
let dragScrollStartTime = 0;
let dragScrollDistance = 0;
let dragScrollHandler: HTMLElement | null = null;
let dragScrollImages: Array<{dataUrl: string, scrollY: number, height: number, timestamp: number}> = [];
let dragScrollInitialRect: DOMRect | null = null;
let dragScrollLastCaptureY = 0;
let dragScrollLastCaptureTime = 0;
let dragScrollCapturing = false;

// æ·»åŠ è‡ªåŠ¨æ»šåŠ¨ç›¸å…³å˜é‡
let autoScrolling = false;
let autoScrollSpeed = 0;
let autoScrollDirection = 0; // 0: æ— æ»šåŠ¨, 1: å‘ä¸‹æ»šåŠ¨, -1: å‘ä¸Šæ»šåŠ¨
let autoScrollIntervalId: number | null = null;
let extendedSelectionStartY = 0; // æ‹–æ‹½å¼€å§‹æ—¶çš„æ–‡æ¡£Yåæ ‡
let extendedSelectionEndY = 0; // æ‹–æ‹½ç»“æŸæ—¶çš„æ–‡æ¡£Yåæ ‡
let isExtendedSelecting = false;

// åˆ›å»ºæˆªå›¾ç›¸å…³çš„DOMå…ƒç´ 
function createScreenshotElements() {
  // åˆ›å»ºé€‰åŒºè¦†ç›–å±‚
  screenshotOverlay = document.createElement('div');
  screenshotOverlay.id = 'ai-assistant-screenshot-overlay';
  screenshotOverlay.style.position = 'fixed';
  screenshotOverlay.style.top = '0';
  screenshotOverlay.style.left = '0';
  screenshotOverlay.style.width = '100%';
  screenshotOverlay.style.height = '100%';
  screenshotOverlay.style.backgroundColor = 'rgba(0, 0, 0, 0.3)';
  screenshotOverlay.style.zIndex = '2147483646';
  screenshotOverlay.style.cursor = 'crosshair';
  screenshotOverlay.style.display = 'none';

  // åˆ›å»ºé€‰åŒºæ¡†
  selectionBox = document.createElement('div');
  selectionBox.id = 'ai-assistant-selection-box';
  selectionBox.style.position = 'fixed';
  selectionBox.style.border = '2px dashed #6e59f2';
  selectionBox.style.backgroundColor = 'rgba(110, 89, 242, 0.1)';
  selectionBox.style.display = 'none';
  selectionBox.style.zIndex = '2147483647';

  // åˆ›å»ºæ»šåŠ¨æ•è·è¿›åº¦æŒ‡ç¤ºå™¨
  scrollCaptureProgress = document.createElement('div');
  scrollCaptureProgress.id = 'ai-assistant-scroll-progress';
  scrollCaptureProgress.style.position = 'fixed';
  scrollCaptureProgress.style.top = '20px';
  scrollCaptureProgress.style.left = '50%';
  scrollCaptureProgress.style.transform = 'translateX(-50%)';
  scrollCaptureProgress.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
  scrollCaptureProgress.style.color = 'white';
  scrollCaptureProgress.style.padding = '12px 20px';
  scrollCaptureProgress.style.borderRadius = '24px';
  scrollCaptureProgress.style.zIndex = '2147483647';
  scrollCaptureProgress.style.display = 'none';
  scrollCaptureProgress.style.fontSize = '14px';
  scrollCaptureProgress.style.fontWeight = 'bold';
  scrollCaptureProgress.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.3)';
  scrollCaptureProgress.style.backdropFilter = 'blur(4px)';
  scrollCaptureProgress.style.transition = 'opacity 0.3s ease';
  scrollCaptureProgress.style.display = 'flex';
  scrollCaptureProgress.style.alignItems = 'center';
  scrollCaptureProgress.style.gap = '10px';
  scrollCaptureProgress.style.display = 'none';

  // æ·»åŠ å›¾æ ‡å…ƒç´ 
  const progressIcon = document.createElement('span');
  progressIcon.textContent = 'ğŸ“¸';
  progressIcon.style.fontSize = '18px';

  // æ·»åŠ æ–‡æœ¬å®¹å™¨
  const progressText = document.createElement('div');
  progressText.id = 'ai-assistant-scroll-progress-text';
  progressText.textContent = 'æ­£åœ¨æ•è·åŒºåŸŸ: 0%';

  // æ·»åŠ åˆ°è¿›åº¦æŒ‡ç¤ºå™¨
  scrollCaptureProgress.appendChild(progressIcon);
  scrollCaptureProgress.appendChild(progressText);

  document.body.appendChild(scrollCaptureProgress);

  // åˆ›å»ºæ§åˆ¶æŒ‰é’®å®¹å™¨ - è™½ç„¶ä¸å†æ˜¾ç¤ºå¤šä¸ªæŒ‰é’®ï¼Œä½†ä¿ç•™å®¹å™¨ç”¨äºå–æ¶ˆæŒ‰é’®
  screenshotControls = document.createElement('div');
  screenshotControls.id = 'ai-assistant-screenshot-controls';
  screenshotControls.style.position = 'fixed';
  screenshotControls.style.display = 'none';
  screenshotControls.style.zIndex = '2147483647';
  screenshotControls.style.backgroundColor = 'white';
  screenshotControls.style.borderRadius = '4px';
  screenshotControls.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.15)';
  screenshotControls.style.padding = '8px';
  screenshotControls.style.display = 'none';
  screenshotControls.style.gap = '8px';

  // åˆ›å»º"å–æ¶ˆ"æŒ‰é’®
  const cancelButton = document.createElement('button');
  cancelButton.textContent = 'å–æ¶ˆ';
  cancelButton.style.backgroundColor = '#f0f0f0';
  cancelButton.style.color = '#333';
  cancelButton.style.border = 'none';
  cancelButton.style.borderRadius = '4px';
  cancelButton.style.padding = '4px 12px';
  cancelButton.style.fontSize = '12px';
  cancelButton.style.cursor = 'pointer';
  cancelButton.onclick = cancelAreaScreenshot;

  // æ·»åŠ æŒ‰é’®åˆ°æ§åˆ¶å®¹å™¨
  screenshotControls.appendChild(cancelButton);

  // å°†å…ƒç´ æ·»åŠ åˆ°é¡µé¢
  document.body.appendChild(screenshotOverlay);
  document.body.appendChild(selectionBox);
  document.body.appendChild(screenshotControls);
}

// å¼€å§‹åŒºåŸŸæˆªå›¾
function startAreaScreenshot() {
  // æ˜¾ç¤ºé€‰æ‹©æ¡†
  if (screenshotOverlay) {
    screenshotOverlay.style.display = 'block';
  }

  // æ·»åŠ é¼ æ ‡äº‹ä»¶ç›‘å¬å™¨
  document.addEventListener('mousedown', handleMouseDown);
  document.addEventListener('mousemove', handleMouseMove);
  document.addEventListener('mouseup', handleMouseUp);
}

// å¤„ç†é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶
function handleMouseDown(e: MouseEvent) {
  console.log('é€‰åŒºå¼€å§‹:', e.clientX, e.clientY);
  isSelecting = true;
  startX = e.clientX;
  startY = e.clientY;
  endX = e.clientX;
  endY = e.clientY;

  updateSelectionBox();

  if (selectionBox) {
    selectionBox.style.display = 'block';
  }
}

// å¤„ç†é¼ æ ‡ç§»åŠ¨äº‹ä»¶
function handleMouseMove(e: MouseEvent) {
  if (!isSelecting) return;

  endX = e.clientX;
  endY = e.clientY;

  updateSelectionBox();
}

// å¤„ç†é¼ æ ‡æ¾å¼€äº‹ä»¶
function handleMouseUp(e: MouseEvent) {
  if (!isSelecting) return;

  console.log('é€‰åŒºç»“æŸ:', endX, endY);
  isSelecting = false;

  // æ£€æŸ¥é€‰æ‹©æ¡†æ˜¯å¦æœ‰è¶³å¤Ÿå¤§å°
  if (selectionBox) {
    const rect = selectionBox.getBoundingClientRect();
    const minSize = 10; // æœ€å°å°ºå¯¸ï¼ˆåƒç´ ï¼‰

    if (rect.width < minSize || rect.height < minSize) {
      console.log('é€‰æ‹©æ¡†å¤ªå°ï¼Œå–æ¶ˆé€‰æ‹©');
      // é€‰æ‹©æ¡†å¤ªå°ï¼Œé‡ç½®æˆªå›¾
      if (selectionBox) selectionBox.style.display = 'none';
      return;
    }

    console.log('é€‰æ‹©æ¡†å°ºå¯¸:', rect.width, 'x', rect.height);
  }

  // æ˜¾ç¤ºæ§åˆ¶æŒ‰é’®
  if (screenshotControls && selectionBox) {
    // åœ¨é€‰åŒºä¸‹æ–¹æ˜¾ç¤ºæ§åˆ¶æŒ‰é’®
    const selectionRect = selectionBox.getBoundingClientRect();
    screenshotControls.style.top = `${selectionRect.bottom + 10}px`;
    screenshotControls.style.left = `${selectionRect.left}px`;
    screenshotControls.style.display = 'flex';

    // ç¡®ä¿æ§åˆ¶æŒ‰é’®åœ¨è§†å£å†…
    const controlsRect = screenshotControls.getBoundingClientRect();
    if (controlsRect.bottom > window.innerHeight) {
      screenshotControls.style.top = `${selectionRect.top - controlsRect.height - 10}px`;
    }
    if (controlsRect.right > window.innerWidth) {
      screenshotControls.style.left = `${window.innerWidth - controlsRect.width - 10}px`;
    }

    console.log('æ˜¾ç¤ºæ§åˆ¶æŒ‰é’®:', controlsRect);
  }

  // ç§»é™¤é¼ æ ‡ç§»åŠ¨ç›‘å¬å™¨
  document.removeEventListener('mousemove', handleMouseMove);
  document.removeEventListener('mouseup', handleMouseUp);

  // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
  showConfirmationDialog();
}

// æ›´æ–°é€‰æ‹©æ¡†ä½ç½®å’Œå¤§å°
function updateSelectionBox() {
  if (!selectionBox) return;

  const left = Math.min(startX, endX);
  const top = Math.min(startY, endY);
  const width = Math.abs(endX - startX);
  const height = Math.abs(endY - startY);

  selectionBox.style.left = `${left}px`;
  selectionBox.style.top = `${top}px`;
  selectionBox.style.width = `${width}px`;
  selectionBox.style.height = `${height}px`;
}

// æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
function showConfirmationDialog() {
  // åˆ›å»ºå¯¹è¯æ¡†å®¹å™¨
  const dialog = document.createElement('div');
  dialog.id = 'ai-assistant-confirmation-dialog';
  dialog.style.position = 'fixed';
  dialog.style.top = '50%';
  dialog.style.left = '50%';
  dialog.style.transform = 'translate(-50%, -50%)';
  dialog.style.zIndex = '2147483647';
  dialog.style.backgroundColor = 'white';
  dialog.style.borderRadius = '4px';
  dialog.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.15)';
  dialog.style.padding = '16px';
  dialog.style.display = 'flex';
  dialog.style.flexDirection = 'column';
  dialog.style.alignItems = 'center';
  dialog.style.gap = '16px';

  // æ·»åŠ æ–‡æœ¬
  const text = document.createElement('div');
  text.textContent = 'ç¡®è®¤è¦å‘é€é€‰å®šåŒºåŸŸçš„æˆªå›¾å—ï¼Ÿ';
  dialog.appendChild(text);

  // æ·»åŠ æŒ‰é’®å®¹å™¨
  const buttonContainer = document.createElement('div');
  buttonContainer.style.display = 'flex';
  buttonContainer.style.gap = '8px';

  // æ·»åŠ "ç¡®è®¤"æŒ‰é’®
  const confirmButton = document.createElement('button');
  confirmButton.textContent = 'ç¡®è®¤';
  confirmButton.style.backgroundColor = '#6e59f2';
  confirmButton.style.color = 'white';
  confirmButton.style.border = 'none';
  confirmButton.style.borderRadius = '4px';
  confirmButton.style.padding = '4px 12px';
  confirmButton.style.fontSize = '12px';
  confirmButton.style.cursor = 'pointer';
  confirmButton.onclick = () => {
    // å…³é—­å¯¹è¯æ¡†
    dialog.remove();
    // æ•è·é€‰å®šåŒºåŸŸ
    captureSelectedArea();
  };
  buttonContainer.appendChild(confirmButton);

  // æ·»åŠ "å–æ¶ˆ"æŒ‰é’®
  const cancelButton = document.createElement('button');
  cancelButton.textContent = 'å–æ¶ˆ';
  cancelButton.style.backgroundColor = '#f0f0f0';
  cancelButton.style.color = '#333';
  cancelButton.style.border = 'none';
  cancelButton.style.borderRadius = '4px';
  cancelButton.style.padding = '4px 12px';
  cancelButton.style.fontSize = '12px';
  cancelButton.style.cursor = 'pointer';
  cancelButton.onclick = () => {
    // å…³é—­å¯¹è¯æ¡†
    dialog.remove();
    // å–æ¶ˆåŒºåŸŸæˆªå›¾
    cancelAreaScreenshot();
  };
  buttonContainer.appendChild(cancelButton);

  // æ·»åŠ æŒ‰é’®å®¹å™¨åˆ°å¯¹è¯æ¡†
  dialog.appendChild(buttonContainer);

  // æ·»åŠ å¯¹è¯æ¡†åˆ°é¡µé¢
  document.body.appendChild(dialog);
}

// æ•è·é€‰å®šåŒºåŸŸ
function captureSelectedArea() {
  if (!selectionBox) return;

  const rect = selectionBox.getBoundingClientRect();

  // ä½¿ç”¨ chrome.tabs.captureVisibleTab æ•è·æ•´ä¸ªå¯è§é¡µé¢
  chrome.runtime.sendMessage({ action: 'getTabId' }, (response) => {
    if (response && response.tabId) {
      // è·å–æˆªå›¾
      chrome.runtime.sendMessage({ action: 'captureScreenshot' }, () => {
        // ç­‰å¾…æˆªå›¾å®Œæˆåï¼Œä»backgroundæ¥æ”¶æ¶ˆæ¯
        chrome.runtime.onMessage.addListener(function listener(message) {
          if (message.action === 'screenshotCaptured' && message.imageUrl) {
            // ç§»é™¤ç›‘å¬å™¨ï¼Œé¿å…é‡å¤å¤„ç†
            chrome.runtime.onMessage.removeListener(listener);

            // è£å‰ªæŒ‡å®šåŒºåŸŸ
            cropImage(message.imageUrl, rect.left, rect.top, rect.width, rect.height).then((croppedDataUrl) => {
              // æå–æ–‡æœ¬ï¼ˆå®é™…åº”ç”¨ä¸­å¯ä½¿ç”¨OCR APIï¼‰
              const exampleText = 'è¿™æ˜¯ä¸€å¼ é€‰å®šåŒºåŸŸçš„æˆªå›¾ã€‚';

              // å‘é€åˆ°ä¾§è¾¹æ 
              chrome.runtime.sendMessage({
                action: 'openSidePanel'
              }, () => {
                setTimeout(() => {
                  chrome.runtime.sendMessage({
                    action: 'addScreenshot',
                    imageUrl: croppedDataUrl,
                    text: exampleText,
                    addToInput: false // é»˜è®¤ä¸æ·»åŠ åˆ°è¾“å…¥æ¡†
                  });
                }, 500);
              });

              // æ¸…ç†æˆªå›¾ç•Œé¢
              cleanupScreenshotUI();
            });
          }
        });
      });
    } else {
      console.error('æ— æ³•è·å–æ ‡ç­¾é¡µID');
      cleanupScreenshotUI();
    }
  });
}

// æ•è·æ•´ä¸ªæ»šåŠ¨é¡µé¢
function captureFullPage() {
  // åˆå§‹åŒ–æ»šåŠ¨æˆªå›¾çŠ¶æ€
  isScrollCapturing = true;
  scrollCaptureImages = [];

  // è®°å½•é¡µé¢ä¿¡æ¯
  totalScrollHeight = Math.max(
    document.body.scrollHeight,
    document.body.offsetHeight,
    document.documentElement.scrollHeight,
    document.documentElement.offsetHeight
  );

  viewportHeight = window.innerHeight;
  currentScrollPosition = window.scrollY;

  // ä¿å­˜åŸå§‹æ»šåŠ¨ä½ç½®ï¼Œä»¥ä¾¿ä¹‹åæ¢å¤
  const originalScrollPosition = window.scrollY;

  // åˆå§‹åŒ–Canvas
  scrollCaptureCanvas = document.createElement('canvas');
  const dpr = window.devicePixelRatio || 1;
  scrollCaptureCanvas.width = document.documentElement.clientWidth * dpr;

  // æ˜¾ç¤ºè¿›åº¦æŒ‡ç¤ºå™¨
  if (scrollCaptureProgress) {
    scrollCaptureProgress.style.display = 'flex';
    const progressText = document.getElementById('ai-assistant-scroll-progress-text');
    if (progressText) {
      progressText.textContent = 'æ­£åœ¨æ•è·æ»šåŠ¨é¡µé¢: 0%';
    }
  }

  // æ¸…ç†é€‰åŒºUIï¼Œåªä¿ç•™è¿›åº¦æŒ‡ç¤ºå™¨
  if (screenshotOverlay) {
    screenshotOverlay.style.display = 'none';
  }

  if (selectionBox) {
    selectionBox.style.display = 'none';
  }

  if (screenshotControls) {
    screenshotControls.style.display = 'none';
  }

  // é˜²æ­¢é¡µé¢æ»šåŠ¨æœŸé—´çš„ç”¨æˆ·äº¤äº’
  const preventInteractionOverlay = document.createElement('div');
  preventInteractionOverlay.id = 'ai-assistant-prevent-interaction';
  preventInteractionOverlay.style.position = 'fixed';
  preventInteractionOverlay.style.top = '0';
  preventInteractionOverlay.style.left = '0';
  preventInteractionOverlay.style.width = '100%';
  preventInteractionOverlay.style.height = '100%';
  preventInteractionOverlay.style.backgroundColor = 'transparent';
  preventInteractionOverlay.style.zIndex = '2147483645';
  preventInteractionOverlay.style.cursor = 'progress';
  document.body.appendChild(preventInteractionOverlay);

  // å¼€å§‹æ»šåŠ¨æ•è·è¿‡ç¨‹
  requestCaptureAndScroll(originalScrollPosition);
}

// è¯·æ±‚æ•è·å½“å‰å¯è§åŒºåŸŸå¹¶æ»šåŠ¨
function requestCaptureAndScroll(originalScrollPosition: number) {
  // ç¡®ä¿æˆ‘ä»¬ä»åœ¨æ•è·æ¨¡å¼
  if (!isScrollCapturing) {
    cleanupScrollCapture(originalScrollPosition);
    return;
  }

  // æ›´æ–°è¿›åº¦æ˜¾ç¤º
  const progress = Math.min(100, Math.round((currentScrollPosition / (totalScrollHeight - viewportHeight)) * 100));
  if (scrollCaptureProgress) {
    const progressText = document.getElementById('ai-assistant-scroll-progress-text');
    if (progressText) {
      progressText.textContent = `æ­£åœ¨æ•è·æ»šåŠ¨é¡µé¢: ${progress}%`;
    }
  }

  // é€šè¿‡æ¶ˆæ¯è¯·æ±‚èƒŒæ™¯è„šæœ¬æ¥æ•è·å½“å‰å¯è§åŒºåŸŸ
  chrome.runtime.sendMessage({ action: 'captureVisibleTabForScroll' }, (response) => {
    if (!response || !response.dataUrl) {
      console.error('æ— æ³•æ•è·å±å¹•:', response?.error || 'æœªçŸ¥é”™è¯¯');
      cleanupScrollCapture(originalScrollPosition);
      return;
    }

    // æ·»åŠ åˆ°å›¾ç‰‡æ•°ç»„
    scrollCaptureImages.push(response.dataUrl);

    // æ£€æŸ¥æ˜¯å¦å·²ç»æ»šåŠ¨åˆ°åº•éƒ¨
    if (currentScrollPosition + viewportHeight >= totalScrollHeight - 50 ||
        currentScrollPosition + viewportHeight >= document.body.scrollHeight - 50) {
      // å·²å®Œæˆæ‰€æœ‰æ»šåŠ¨ï¼Œåˆå¹¶å›¾ç‰‡
      finishScrollCapture(originalScrollPosition);
      return;
    }

    // è®¡ç®—ä¸‹ä¸€ä¸ªæ»šåŠ¨ä½ç½®ï¼Œæ¯æ¬¡æ»šåŠ¨90%è§†å£é«˜åº¦ä»¥ç¡®ä¿æœ‰é‡å 
    const nextScrollY = Math.min(currentScrollPosition + viewportHeight * 0.9, totalScrollHeight - viewportHeight);

    // æ»šåŠ¨åˆ°ä¸‹ä¸€ä¸ªä½ç½®
    window.scrollTo({
      top: nextScrollY,
      behavior: 'smooth' // ä½¿ç”¨å³æ—¶æ»šåŠ¨è€Œä¸æ˜¯å¹³æ»‘æ»šåŠ¨
    });

    // æ›´æ–°å½“å‰æ»šåŠ¨ä½ç½®
    currentScrollPosition = nextScrollY;

    // ç­‰å¾…ä¸€æ®µæ—¶é—´è®©é¡µé¢ç¨³å®šå†æ•è·ä¸‹ä¸€å±
    setTimeout(() => requestCaptureAndScroll(originalScrollPosition), 450);
  });
}

// å®Œæˆæ»šåŠ¨æ•è·å¹¶åˆå¹¶å›¾ç‰‡
function finishScrollCapture(originalScrollPosition: number) {
  if (!isScrollCapturing || scrollCaptureImages.length === 0) {
    cleanupScrollCapture(originalScrollPosition);
    return;
  }

  // æ›´æ–°è¿›åº¦æ˜¾ç¤º
  if (scrollCaptureProgress) {
    const progressText = document.getElementById('ai-assistant-scroll-progress-text');
    if (progressText) {
      progressText.textContent = 'æ­£åœ¨å¤„ç†æ•è·çš„å›¾åƒ...';
    }
  }

  // å‡†å¤‡åˆå¹¶å›¾åƒ
  const mergeImages = async () => {
    if (!scrollCaptureCanvas) {
      scrollCaptureCanvas = document.createElement('canvas');
    }

    const dpr = window.devicePixelRatio || 1;
    const canvasWidth = document.documentElement.clientWidth * dpr;

    // åˆ›å»ºä¸´æ—¶å›¾åƒå¯¹è±¡æ¥è·å–å°ºå¯¸
    const loadImagePromises = scrollCaptureImages.map(imgUrl => {
      return new Promise<HTMLImageElement>((resolve) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.src = imgUrl;
      });
    });

    try {
      // ç­‰å¾…æ‰€æœ‰å›¾åƒåŠ è½½
      const images = await Promise.all(loadImagePromises);

      // è®¡ç®—æ€»é«˜åº¦ï¼Œè€ƒè™‘90%é‡å 
      const uniqueHeightPerImage = images[0].height * 0.9;
      const totalCanvasHeight = Math.min(
        (images.length - 1) * uniqueHeightPerImage + images[0].height,
        totalScrollHeight * dpr
      );

      // è®¾ç½®canvaså¤§å°
      scrollCaptureCanvas.width = canvasWidth;
      scrollCaptureCanvas.height = totalCanvasHeight;
      scrollCaptureContext = scrollCaptureCanvas.getContext('2d');

      if (!scrollCaptureContext) {
        throw new Error('æ— æ³•è·å–Canvasä¸Šä¸‹æ–‡');
      }

      // ç»˜åˆ¶æ¯ä¸ªå›¾åƒï¼ŒæŒ‰é¡ºåºåç§»
      images.forEach((img, index) => {
        const yOffset = index * uniqueHeightPerImage;
        scrollCaptureContext?.drawImage(img, 0, yOffset);
      });

      // è·å–åˆå¹¶åçš„å›¾åƒ
      const mergedImageUrl = scrollCaptureCanvas.toDataURL('image/png');

      // å‘é€åˆå¹¶åçš„å›¾åƒåˆ°ä¾§è¾¹æ 
      chrome.runtime.sendMessage({
        action: 'openSidePanel'
      }, () => {
        requestAnimationFrame(() => {
          setTimeout(() => {
            chrome.runtime.sendMessage({
              action: 'addScreenshot',
              imageUrl: mergedImageUrl,
              text: 'æ»šåŠ¨é¡µé¢æˆªå›¾',
              addToInput: true // æ·»åŠ åˆ°è¾“å…¥æ¡†
            });
          }, 500);
        });
      });

    } catch (error) {
      console.error('åˆå¹¶å›¾åƒå¤±è´¥:', error);
    } finally {
      cleanupScrollCapture(originalScrollPosition);
    }
  };

  // æ‰§è¡Œåˆå¹¶
  mergeImages();
}

// æ¸…ç†æ»šåŠ¨æ•è·èµ„æº
function cleanupScrollCapture(originalScrollPosition?: number) {
  isScrollCapturing = false;
  scrollCaptureImages = [];
  scrollCaptureCanvas = null;
  scrollCaptureContext = null;

  // æ»šåŠ¨å›åŸä½ç½®
  if (originalScrollPosition !== undefined) {
    window.scrollTo({
      top: originalScrollPosition,
      behavior: 'smooth'
    });
  } else {
    window.scrollTo({
      top: 0,
      behavior: 'smooth'
    });
  }

  // éšè—è¿›åº¦æŒ‡ç¤ºå™¨
  if (scrollCaptureProgress) {
    scrollCaptureProgress.style.display = 'none';
  }

  // ç§»é™¤äº¤äº’é˜»æ­¢å±‚
  const preventInteractionOverlay = document.getElementById('ai-assistant-prevent-interaction');
  if (preventInteractionOverlay) {
    preventInteractionOverlay.remove();
  }

  // å…¨éƒ¨æ¸…ç†
  cleanupScreenshotUI();
}

// å–æ¶ˆåŒºåŸŸæˆªå›¾
function cancelAreaScreenshot() {
  console.log('å–æ¶ˆåŒºåŸŸæˆªå›¾');
  cleanupScreenshotUI();
}

// æ¸…ç†æˆªå›¾ç•Œé¢ - ä¿®æ”¹ä»¥ç¡®ä¿æ¸…ç†æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
function cleanupScreenshotUI() {
  console.log('æ¸…ç†æˆªå›¾ç•Œé¢');

  // é‡ç½®çŠ¶æ€
  isSelecting = false;
  isExtendedSelecting = false;
  stopAutoScroll();

  if (screenshotOverlay) {
    screenshotOverlay.style.display = 'none';
    screenshotOverlay.removeEventListener('mousedown', handleExtendedMouseDown);
  }

  if (selectionBox) {
    selectionBox.style.display = 'none';
  }

  if (screenshotControls) {
    screenshotControls.style.display = 'none';
  }

  // ç§»é™¤æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
  document.removeEventListener('mousemove', handleExtendedMouseMove);
  document.removeEventListener('mouseup', handleExtendedMouseUp);
  document.removeEventListener('keydown', handleKeyDown);

  document.body.style.overflow = '';
}

// è£å‰ªå›¾åƒ - ä¿ç•™ç”¨äºå¯èƒ½çš„åç»­å¤„ç†
function cropImage(dataUrl: string, left: number, top: number, width: number, height: number): Promise<string> {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = function() {
      // åˆ›å»ºç”»å¸ƒ
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      // è®¾ç½®ç”»å¸ƒå¤§å°ä¸ºè£å‰ªåŒºåŸŸå¤§å°
      canvas.width = width;
      canvas.height = height;

      // è·å–è®¾å¤‡åƒç´ æ¯”ä»¥å¤„ç†é«˜åˆ†è¾¨ç‡å±å¹•
      const dpr = window.devicePixelRatio || 1;

      // è®¡ç®—ç¼©æ”¾åçš„åæ ‡å’Œå°ºå¯¸
      const scaledLeft = left * dpr;
      const scaledTop = top * dpr;
      const scaledWidth = width * dpr;
      const scaledHeight = height * dpr;

      // è£å‰ªå›¾åƒ
      if (ctx) {
        ctx.drawImage(
          img,
          scaledLeft, scaledTop, scaledWidth, scaledHeight, // æºå›¾åƒè£å‰ªåŒºåŸŸ
          0, 0, width, height // ç›®æ ‡ç”»å¸ƒåŒºåŸŸ
        );
      }

      // å°†è£å‰ªåçš„å›¾åƒè½¬æ¢ä¸º data URL
      const croppedDataUrl = canvas.toDataURL('image/png');
      resolve(croppedDataUrl);
    };

    // è®¾ç½®å›¾åƒæº
    img.src = dataUrl;
  });
}

// è®¾ç½®æ–‡æœ¬é€‰æ‹©å¤„ç†å™¨
function setupTextSelectionHandler() {
  // å½“æ–‡æœ¬è¢«é€‰ä¸­æ—¶ï¼Œæ˜¾ç¤ºæµ®åŠ¨å·¥å…·æ 
  document.addEventListener('mouseup', (event) => {
    // å¦‚æœæ­£åœ¨è¿›è¡Œæˆªå›¾ï¼Œä¸è¦æ˜¾ç¤ºæ–‡æœ¬é€‰æ‹©å·¥å…·æ 
    if (isSelecting) return;

    // è·å–é€‰ä¸­çš„æ–‡æœ¬
    const selectedText = window.getSelection()?.toString();

    // å¦‚æœæœ‰é€‰ä¸­çš„æ–‡æœ¬ï¼Œæ˜¾ç¤ºæµ®åŠ¨å·¥å…·æ 
    if (selectedText && selectedText.trim().length > 0) {
      showFloatingToolbar(event.clientX, event.clientY, selectedText);
    } else {
      // å¦åˆ™ï¼Œéšè—æµ®åŠ¨å·¥å…·æ 
      hideFloatingToolbar();
    }
  });

  // ç‚¹å‡»é¡µé¢æ—¶ï¼Œå¦‚æœä¸æ˜¯æµ®åŠ¨å·¥å…·æ å†…éƒ¨ï¼Œåˆ™éšè—å·¥å…·æ 
  document.addEventListener('mousedown', (event) => {
    const toolbar = document.getElementById('ai-assistant-toolbar');
    if (toolbar && !toolbar.contains(event.target as Node)) {
      hideFloatingToolbar();
    }
  });
}

// æ˜¾ç¤ºæµ®åŠ¨å·¥å…·æ 
function showFloatingToolbar(x: number, y: number, selectedText: string) {
  // ç§»é™¤ç°æœ‰çš„å·¥å…·æ ï¼ˆå¦‚æœæœ‰ï¼‰
  hideFloatingToolbar();

  // åˆ›å»ºå·¥å…·æ å®¹å™¨
  const toolbar = document.createElement('div');
  toolbar.id = 'ai-assistant-toolbar';
  toolbar.style.position = 'fixed';
  toolbar.style.left = `${x}px`;
  toolbar.style.top = `${y + 20}px`; // åœ¨é¼ æ ‡ä¸‹æ–¹æ˜¾ç¤º
  toolbar.style.zIndex = '2147483647'; // æœ€é«˜å±‚çº§
  toolbar.style.backgroundColor = 'white';
  toolbar.style.border = '1px solid #d9d9d9';
  toolbar.style.borderRadius = '4px';
  toolbar.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.15)';
  toolbar.style.padding = '6px 8px';
  toolbar.style.display = 'flex';
  toolbar.style.alignItems = 'center';
  toolbar.style.gap = '8px';

  // æ·»åŠ "å‘é€åˆ°AIåŠ©æ‰‹"æŒ‰é’®
  const sendButton = document.createElement('button');
  sendButton.textContent = 'å‘é€åˆ°AIåŠ©æ‰‹';
  sendButton.style.backgroundColor = '#6e59f2';
  sendButton.style.color = 'white';
  sendButton.style.border = 'none';
  sendButton.style.borderRadius = '4px';
  sendButton.style.padding = '4px 8px';
  sendButton.style.fontSize = '12px';
  sendButton.style.cursor = 'pointer';

  // ç‚¹å‡»æŒ‰é’®æ—¶ï¼Œå‘é€é€‰ä¸­çš„æ–‡æœ¬åˆ°AIåŠ©æ‰‹
  sendButton.addEventListener('click', () => {
    // å…ˆå‘åå°å‘é€æ‰“å¼€ä¾§è¾¹æ çš„è¯·æ±‚
    chrome.runtime.sendMessage({
      action: 'openSidePanel'
    }, () => {
      // ç„¶åå‘é€é€‰ä¸­çš„æ–‡æœ¬
      requestAnimationFrame(() => {
        setTimeout(() => {
          chrome.runtime.sendMessage({
            action: 'addSelectedText',
            text: selectedText
          });
        }, 500); // ç»™ä¾§è¾¹æ æ‰“å¼€ç•™å‡ºæ—¶é—´
      });
    });

    // éšè—å·¥å…·æ 
    hideFloatingToolbar();
  });

  toolbar.appendChild(sendButton);

  // æ·»åŠ åˆ°é¡µé¢
  document.body.appendChild(toolbar);

  // ç¡®ä¿å·¥å…·æ å®Œå…¨åœ¨è§†å£å†…
  const rect = toolbar.getBoundingClientRect();
  if (rect.right > window.innerWidth) {
    toolbar.style.left = `${window.innerWidth - rect.width - 10}px`;
  }
  if (rect.bottom > window.innerHeight) {
    toolbar.style.top = `${y - rect.height - 10}px`;
  }
}

// éšè—æµ®åŠ¨å·¥å…·æ 
function hideFloatingToolbar() {
  const toolbar = document.getElementById('ai-assistant-toolbar');
  if (toolbar) {
    toolbar.remove();
  }
}

// å¼€å§‹ç”¨æˆ·æ‹–æ‹½æ»šåŠ¨æˆªå›¾
function startUserDragScrollCapture() {
  console.log('å¼€å§‹æ‹–æ‹½æ»šåŠ¨æˆªå›¾...');
  // ä¿å­˜é€‰æ‹©åŒºåŸŸä¿¡æ¯
  if (!selectionBox) {
    console.error('æ— æ³•æ‰¾åˆ°é€‰æ‹©æ¡†');
    return;
  }

  // ä¿å­˜åˆå§‹é€‰æ‹©æ¡†ä½ç½®
  dragScrollInitialRect = selectionBox.getBoundingClientRect();
  console.log('é€‰æ‹©æ¡†ä½ç½®:', dragScrollInitialRect);

  // åˆå§‹åŒ–å˜é‡
  dragScrollImages = [];
  dragScrollLastCaptureY = window.scrollY;
  dragScrollLastCaptureTime = Date.now();
  dragScrollCapturing = true;

  // è®°å½•åˆå§‹æ»šåŠ¨ä½ç½®
  scrollStartY = window.scrollY;

  // æ¸…ç†é€‰åŒºUIï¼Œä½†ä¿ç•™é€‰æ‹©æ¡†ä½ç½®æŒ‡ç¤º
  if (screenshotOverlay) {
    screenshotOverlay.style.display = 'none';
  }

  if (screenshotControls) {
    screenshotControls.style.display = 'none';
  }

  // åˆ›å»ºæ‹–æ‹½å¤„ç†å™¨
  createDragScrollHandler();

  // å…è®¸é¡µé¢æ»šåŠ¨
  document.body.style.overflow = 'auto';

  // æ˜¾ç¤ºæç¤º
  showDragCaptureToast('å‘ä¸‹æ‹–åŠ¨æ¥æ»šåŠ¨é¡µé¢ï¼Œé‡Šæ”¾é¼ æ ‡åœæ­¢æˆªå›¾');

  // æ˜¾ç¤ºè¿›åº¦æŒ‡ç¤ºå™¨
  if (scrollCaptureProgress) {
    scrollCaptureProgress.style.display = 'flex';
    const progressText = document.getElementById('ai-assistant-scroll-progress-text');
    if (progressText) {
      progressText.textContent = 'å‡†å¤‡å¼€å§‹æ‹–æ‹½æˆªå›¾ï¼Œè¯·å‘ä¸‹æ‹–åŠ¨...';
    }
  }

  // æ·»åŠ ESCé”®ç›˜ç›‘å¬ï¼Œç”¨äºå–æ¶ˆæˆªå›¾
  document.addEventListener('keydown', handleKeyDown);

  // æ•è·åˆå§‹å±å¹•
  captureViewportForDragScroll();
}

// åˆ›å»ºæ‹–æ‹½æ»šåŠ¨å¤„ç†å™¨
function createDragScrollHandler() {
  console.log('åˆ›å»ºæ‹–æ‹½å¤„ç†å™¨...');
  // æ¸…ç†å·²æœ‰å¤„ç†å™¨
  const existingHandler = document.getElementById('ai-assistant-drag-scroll-handler');
  if (existingHandler) {
    existingHandler.remove();
  }

  // åˆ›å»ºæ–°å¤„ç†å™¨ - ä¸€ä¸ªè¦†ç›–æ•´ä¸ªå±å¹•çš„é€æ˜å±‚
  dragScrollHandler = document.createElement('div');
  dragScrollHandler.id = 'ai-assistant-drag-scroll-handler';
  dragScrollHandler.style.position = 'fixed';
  dragScrollHandler.style.top = '0';
  dragScrollHandler.style.left = '0';
  dragScrollHandler.style.width = '100%';
  dragScrollHandler.style.height = '100%';
  dragScrollHandler.style.backgroundColor = 'rgba(0, 0, 0, 0.1)';
  dragScrollHandler.style.zIndex = '2147483647';
  dragScrollHandler.style.cursor = 'grab';

  // æ·»åŠ çŠ¶æ€æŒ‡ç¤ºå™¨
  const statusIndicator = document.createElement('div');
  statusIndicator.id = 'ai-assistant-drag-status';
  statusIndicator.style.position = 'fixed';
  statusIndicator.style.bottom = '20px';
  statusIndicator.style.right = '20px';
  statusIndicator.style.backgroundColor = 'rgba(33, 150, 243, 0.8)';
  statusIndicator.style.color = 'white';
  statusIndicator.style.padding = '8px 16px';
  statusIndicator.style.borderRadius = '20px';
  statusIndicator.style.fontSize = '14px';
  statusIndicator.style.fontWeight = 'bold';
  statusIndicator.textContent = 'âœ‹ æŒ‰ä½å¹¶æ‹–åŠ¨';
  dragScrollHandler.appendChild(statusIndicator);

  // æ·»åŠ å®ŒæˆæŒ‰é’®
  const finishButton = document.createElement('button');
  finishButton.id = 'ai-assistant-drag-finish';
  finishButton.style.position = 'fixed';
  finishButton.style.bottom = '20px';
  finishButton.style.left = '20px';
  finishButton.style.backgroundColor = '#4CAF50';
  finishButton.style.color = 'white';
  finishButton.style.border = 'none';
  finishButton.style.borderRadius = '4px';
  finishButton.style.padding = '8px 16px';
  finishButton.style.fontSize = '14px';
  finishButton.style.cursor = 'pointer';
  finishButton.style.fontWeight = 'bold';
  finishButton.textContent = 'å®Œæˆæˆªå›¾';
  finishButton.onclick = finishUserDragScrollCapture;
  dragScrollHandler.appendChild(finishButton);

  // æ·»åŠ å–æ¶ˆæŒ‰é’®
  const cancelButton = document.createElement('button');
  cancelButton.id = 'ai-assistant-drag-cancel';
  cancelButton.style.position = 'fixed';
  cancelButton.style.bottom = '20px';
  cancelButton.style.left = '120px'; // æ”¾åœ¨å®ŒæˆæŒ‰é’®æ—è¾¹
  cancelButton.style.backgroundColor = '#F44336';
  cancelButton.style.color = 'white';
  cancelButton.style.border = 'none';
  cancelButton.style.borderRadius = '4px';
  cancelButton.style.padding = '8px 16px';
  cancelButton.style.fontSize = '14px';
  cancelButton.style.cursor = 'pointer';
  cancelButton.style.fontWeight = 'bold';
  cancelButton.textContent = 'å–æ¶ˆæˆªå›¾';
  cancelButton.onclick = cleanupUserDragScrollCapture;
  dragScrollHandler.appendChild(cancelButton);

  // æ·»åŠ æç¤ºæ–‡æœ¬
  const hintText = document.createElement('div');
  hintText.id = 'ai-assistant-drag-hint';
  hintText.style.position = 'fixed';
  hintText.style.top = '20px';
  hintText.style.left = '50%';
  hintText.style.transform = 'translateX(-50%)';
  hintText.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
  hintText.style.color = 'white';
  hintText.style.padding = '8px 16px';
  hintText.style.borderRadius = '20px';
  hintText.style.fontSize = '14px';
  hintText.style.fontWeight = 'bold';
  hintText.textContent = 'æŒ‰ä½é¼ æ ‡å¹¶æ‹–åŠ¨ï¼ŒæŒ‰ESCé€€å‡ºæˆªå›¾';
  dragScrollHandler.appendChild(hintText);

  console.log('è®¾ç½®æ‹–æ‹½äº‹ä»¶ç›‘å¬...');
  // ç›´æ¥åœ¨å¤„ç†å™¨ä¸Šæ·»åŠ ç›¸åº”çš„äº‹ä»¶ï¼Œç»•è¿‡äº‹ä»¶å†’æ³¡é—®é¢˜
  dragScrollHandler.onmousedown = handleDragScrollStart;
  dragScrollHandler.ontouchstart = handleDragScrollTouchStart;

  // æ·»åŠ åˆ°é¡µé¢
  document.body.appendChild(dragScrollHandler);
  console.log('æ‹–æ‹½å¤„ç†å™¨å·²æ·»åŠ åˆ°é¡µé¢');
}

// å¤„ç†æ‹–æ‹½å¼€å§‹ - é¼ æ ‡
function handleDragScrollStart(e: MouseEvent) {
  console.log('æ‹–æ‹½å¼€å§‹...');
  if (!dragScrollCapturing) return;

  // é˜²æ­¢é»˜è®¤è¡Œä¸ºå’Œå†’æ³¡
  e.preventDefault();
  e.stopPropagation();

  // è®°å½•å¼€å§‹ä½ç½®
  isDragging = true;
  mouseStartY = e.clientY;
  mouseCurrentY = e.clientY;
  scrollStartY = window.scrollY;
  dragScrollStartTime = Date.now();
  dragScrollDistance = 0;

  // æ›´æ”¹é¼ æ ‡æ ·å¼
  if (dragScrollHandler) {
    dragScrollHandler.style.cursor = 'grabbing';

    // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
    const statusIndicator = document.getElementById('ai-assistant-drag-status');
    if (statusIndicator) {
      statusIndicator.textContent = 'âœŠ æ­£åœ¨æ‹–æ‹½...';
    }
  }

  // æ·»åŠ é¼ æ ‡ç§»åŠ¨å’Œé‡Šæ”¾äº‹ä»¶
  document.addEventListener('mousemove', handleDragScrollMove);
  document.addEventListener('mouseup', handleDragScrollEnd);

  console.log('æ‹–æ‹½äº‹ä»¶ç›‘å¬å™¨å·²æ·»åŠ ');
}

// å¤„ç†æ‹–æ‹½å¼€å§‹ - è§¦æ‘¸
function handleDragScrollTouchStart(e: TouchEvent) {
  if (!dragScrollCapturing || !e.touches[0]) return;

  // é˜²æ­¢é»˜è®¤è¡Œä¸ºå’Œå†’æ³¡
  e.preventDefault();
  e.stopPropagation();

  // è®°å½•å¼€å§‹ä½ç½®
  isDragging = true;
  mouseStartY = e.touches[0].clientY;
  mouseCurrentY = e.touches[0].clientY;
  scrollStartY = window.scrollY;
  dragScrollStartTime = Date.now();
  dragScrollDistance = 0;

  // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
  const statusIndicator = document.getElementById('ai-assistant-drag-status');
  if (statusIndicator) {
    statusIndicator.textContent = 'æ­£åœ¨æ‹–æ‹½...';
  }

  // æ·»åŠ è§¦æ‘¸ç§»åŠ¨å’Œç»“æŸäº‹ä»¶
  document.addEventListener('touchmove', handleDragScrollTouchMove);
  document.addEventListener('touchend', handleDragScrollTouchEnd);
}

// å¤„ç†æ‹–æ‹½ç§»åŠ¨ - é¼ æ ‡
function handleDragScrollMove(e: MouseEvent) {
  if (!isDragging || !dragScrollCapturing) return;

  // é˜²æ­¢é»˜è®¤è¡Œä¸ºå’Œå†’æ³¡
  e.preventDefault();
  e.stopPropagation();

  // æ›´æ–°å½“å‰ä½ç½®
  mouseCurrentY = e.clientY;

  // è®¡ç®—æ‹–æ‹½è·ç¦»å’Œæ–¹å‘
  const deltaY = mouseStartY - mouseCurrentY;

  // åŠ å…¥çµæ•åº¦è°ƒæ•´ï¼Œè®©æ»šåŠ¨æ›´å¹³æ»‘
  const sensitivity = 1.2;
  const adjustedDeltaY = deltaY * sensitivity;

  // å¦‚æœæ‹–æ‹½è·ç¦»è¶³å¤Ÿå¤§ï¼Œæ‰§è¡Œæ»šåŠ¨
  if (Math.abs(deltaY) > 2) { // é™ä½é˜ˆå€¼ï¼Œæé«˜çµæ•åº¦
    // è®¡ç®—æ–°æ»šåŠ¨ä½ç½®
    const newScrollY = window.scrollY + adjustedDeltaY;

    // é™åˆ¶æ»šåŠ¨èŒƒå›´ï¼Œç¡®ä¿ä¸ä¼šæ»šåŠ¨åˆ°é¡µé¢ä¹‹å¤–
    const maxScrollY = Math.max(
      document.body.scrollHeight,
      document.documentElement.scrollHeight
    ) - window.innerHeight;

    const boundedScrollY = Math.max(0, Math.min(newScrollY, maxScrollY));

    // æ»šåŠ¨åˆ°æ–°ä½ç½®
    window.scrollTo({
      top: boundedScrollY,
      behavior: 'auto'
    });

    // ç´¯è®¡æ‹–æ‹½è·ç¦»
    dragScrollDistance += Math.abs(adjustedDeltaY);

    // é‡ç½®é¼ æ ‡å¼€å§‹ä½ç½®ï¼Œä»¥ä¾¿è¿ç»­æ»šåŠ¨
    mouseStartY = mouseCurrentY;

    // æ›´æ–°è¿›åº¦æ˜¾ç¤º
    updateDragScrollProgress();

    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ•è·æ–°çš„å±å¹•
    checkCaptureViewport();
  }
}

// å¤„ç†æ‹–æ‹½ç§»åŠ¨ - è§¦æ‘¸
function handleDragScrollTouchMove(e: TouchEvent) {
  if (!isDragging || !dragScrollCapturing || !e.touches[0]) return;

  // é˜²æ­¢é»˜è®¤è¡Œä¸ºå’Œå†’æ³¡
  e.preventDefault();
  e.stopPropagation();

  // æ›´æ–°å½“å‰ä½ç½®
  mouseCurrentY = e.touches[0].clientY;

  // è®¡ç®—æ‹–æ‹½è·ç¦»å’Œæ–¹å‘
  const deltaY = mouseStartY - mouseCurrentY;

  // è®¡ç®—æ»šåŠ¨é€Ÿåº¦ - æ ¹æ®æ‹–æ‹½è·ç¦»åŠ¨æ€è°ƒæ•´
  const speed = Math.abs(deltaY) * 1.5;

  // å¦‚æœæ‹–æ‹½è·ç¦»è¶³å¤Ÿå¤§ï¼Œæ‰§è¡Œæ»šåŠ¨
  if (Math.abs(deltaY) > 5) {
    // è®¡ç®—æ–°æ»šåŠ¨ä½ç½®
    const newScrollY = window.scrollY + deltaY;

    // æ»šåŠ¨åˆ°æ–°ä½ç½®
    window.scrollTo({
      top: newScrollY,
      behavior: 'auto'
    });

    // ç´¯è®¡æ‹–æ‹½è·ç¦»
    dragScrollDistance += Math.abs(deltaY);

    // é‡ç½®é¼ æ ‡å¼€å§‹ä½ç½®ï¼Œä»¥ä¾¿è¿ç»­æ»šåŠ¨
    mouseStartY = mouseCurrentY;

    // æ›´æ–°è¿›åº¦æ˜¾ç¤º
    updateDragScrollProgress();

    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ•è·æ–°çš„å±å¹•
    checkCaptureViewport();
  }
}

// å¤„ç†æ‹–æ‹½ç»“æŸ - é¼ æ ‡
function handleDragScrollEnd(e: MouseEvent) {
  if (!isDragging || !dragScrollCapturing) return;

  // é˜²æ­¢é»˜è®¤è¡Œä¸ºå’Œå†’æ³¡
  e.preventDefault();
  e.stopPropagation();

  // é‡ç½®æ‹–æ‹½çŠ¶æ€
  isDragging = false;

  // æ›´æ”¹é¼ æ ‡æ ·å¼
  if (dragScrollHandler) {
    dragScrollHandler.style.cursor = 'grab';

    // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
    const statusIndicator = document.getElementById('ai-assistant-drag-status');
    if (statusIndicator) {
      statusIndicator.textContent = 'âœ‹ æŒ‰ä½å¹¶æ‹–åŠ¨';
    }
  }

  // ç§»é™¤äº‹ä»¶ç›‘å¬
  document.removeEventListener('mousemove', handleDragScrollMove);
  document.removeEventListener('mouseup', handleDragScrollEnd);

  // å¦‚æœæ‹–æ‹½è·ç¦»è¶³å¤Ÿå¤§ï¼Œæ•è·æœ€åä¸€å±
  if (dragScrollDistance > 20) {
    captureViewportForDragScroll();
  }
}

// å¤„ç†æ‹–æ‹½ç»“æŸ - è§¦æ‘¸
function handleDragScrollTouchEnd(e: TouchEvent) {
  if (!isDragging || !dragScrollCapturing) return;

  // é˜²æ­¢é»˜è®¤è¡Œä¸ºå’Œå†’æ³¡
  e.preventDefault();
  e.stopPropagation();

  // é‡ç½®æ‹–æ‹½çŠ¶æ€
  isDragging = false;

  // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
  const statusIndicator = document.getElementById('ai-assistant-drag-status');
  if (statusIndicator) {
    statusIndicator.textContent = 'æŒ‰ä½å¹¶æ‹–åŠ¨';
  }

  // ç§»é™¤äº‹ä»¶ç›‘å¬
  document.removeEventListener('touchmove', handleDragScrollTouchMove);
  document.removeEventListener('touchend', handleDragScrollTouchEnd);

  // å¦‚æœæ‹–æ‹½è·ç¦»è¶³å¤Ÿå¤§ï¼Œæ•è·æœ€åä¸€å±
  if (dragScrollDistance > 20) {
    captureViewportForDragScroll();
  }
}

// æ›´æ–°æ‹–æ‹½æ»šåŠ¨è¿›åº¦
function updateDragScrollProgress() {
  if (!scrollCaptureProgress) return;

  // è®¡ç®—æ€»æ»šåŠ¨é«˜åº¦å’Œå½“å‰ä½ç½®
  const totalHeight = Math.max(
    document.body.scrollHeight,
    document.documentElement.scrollHeight
  ) - window.innerHeight;

  const currentProgress = Math.min(100, Math.round((window.scrollY / totalHeight) * 100));

  // æ›´æ–°è¿›åº¦æ–‡æœ¬
  const progressText = document.getElementById('ai-assistant-scroll-progress-text');
  if (progressText) {
    progressText.textContent = `æ­£åœ¨æ‹–æ‹½æˆªå›¾: ${currentProgress}%`;
  }
}

// æ£€æŸ¥æ˜¯å¦éœ€è¦æ•è·å½“å‰è§†å›¾
function checkCaptureViewport() {
  // è®¡ç®—è‡ªä¸Šæ¬¡æ•è·ä»¥æ¥çš„æ»šåŠ¨è·ç¦»
  const scrollDelta = Math.abs(window.scrollY - dragScrollLastCaptureY);

  // æ£€æŸ¥è·ç¦»ä¸Šæ¬¡æ•è·çš„æ—¶é—´
  const timeDelta = Date.now() - dragScrollLastCaptureTime;

  // æ ¹æ®é¡µé¢é«˜åº¦åŠ¨æ€è°ƒæ•´æ•è·é¢‘ç‡
  const captureThreshold = window.innerHeight * 0.3; // é™ä½åˆ°30%çš„è§†å£é«˜åº¦
  const timeThreshold = 200; // é™ä½åˆ°200ms

  // å¦‚æœæ»šåŠ¨è·ç¦»è¶…è¿‡å±å¹•é«˜åº¦çš„30%æˆ–æ—¶é—´è¶…è¿‡200msï¼Œæ•è·å½“å‰è§†å›¾
  if (scrollDelta > captureThreshold || timeDelta > timeThreshold) {
    console.log(`è§¦å‘æˆªå›¾ - æ»šåŠ¨: ${scrollDelta}px, æ—¶é—´: ${timeDelta}ms`);
    captureViewportForDragScroll();
  }
}

// æ•è·å½“å‰è§†å›¾ç”¨äºæ‹–æ‹½æ»šåŠ¨
function captureViewportForDragScroll() {
  console.log('æ•è·å½“å‰è§†å›¾ï¼Œæ»šåŠ¨ä½ç½®:', window.scrollY);
  // æ›´æ–°æœ€åæ•è·ä½ç½®å’Œæ—¶é—´
  dragScrollLastCaptureY = window.scrollY;
  dragScrollLastCaptureTime = Date.now();

  // é€šè¿‡æ¶ˆæ¯è¯·æ±‚èƒŒæ™¯è„šæœ¬æ¥æ•è·å½“å‰å¯è§åŒºåŸŸ
  chrome.runtime.sendMessage({ action: 'captureVisibleTabForScroll' }, (response) => {
    if (!response || !response.dataUrl) {
      console.error('æ— æ³•æ•è·å±å¹•:', response?.error || 'æœªçŸ¥é”™è¯¯');
      return;
    }

    console.log('æˆåŠŸæ•è·å½“å‰å±å¹•');
    // æ·»åŠ åˆ°å›¾ç‰‡æ•°ç»„
    dragScrollImages.push({
      dataUrl: response.dataUrl,
      scrollY: window.scrollY,
      height: window.innerHeight,
      timestamp: Date.now()
    });

    // æ›´æ–°è¿›åº¦æ˜¾ç¤ºä¸­æ·»åŠ å·²æ•è·æ•°é‡
    updateDragScrollProgress();
  });
}

// å®Œæˆç”¨æˆ·æ‹–æ‹½æ»šåŠ¨æˆªå›¾
function finishUserDragScrollCapture() {
  console.log('å®Œæˆæ‹–æ‹½æˆªå›¾ï¼Œå…±æ•è·', dragScrollImages.length, 'å¼ å›¾ç‰‡');

  if (!dragScrollCapturing || dragScrollImages.length === 0) {
    console.warn('æ²¡æœ‰æ•è·ä»»ä½•å›¾ç‰‡ï¼Œæ¸…ç†èµ„æº');
    cleanupUserDragScrollCapture();
    return;
  }

  // æ›´æ–°è¿›åº¦æ˜¾ç¤º
  if (scrollCaptureProgress) {
    scrollCaptureProgress.style.display = 'flex';
    const progressText = document.getElementById('ai-assistant-scroll-progress-text');
    if (progressText) {
      progressText.textContent = 'æ­£åœ¨å¤„ç†æ‹–æ‹½æˆªå›¾...';
    }
  }

  // æ•è·æœ€åä¸€å±
  chrome.runtime.sendMessage({ action: 'captureVisibleTabForScroll' }, async (response) => {
    if (response && response.dataUrl) {
      // æ·»åŠ æœ€åä¸€å±
      console.log('æ·»åŠ æœ€åä¸€å±ï¼Œä½ç½®:', window.scrollY);
      dragScrollImages.push({
        dataUrl: response.dataUrl,
        scrollY: window.scrollY,
        height: window.innerHeight,
        timestamp: Date.now()
      });
    }

    try {
      // åœ¨å¤„ç†ä¹‹å‰å…ˆæ˜¾ç¤ºåŠ è½½æç¤º
      showDragCaptureToast('æ­£åœ¨å¤„ç†æˆªå›¾ï¼Œè¯·ç¨å€™...');

      // æŒ‰æ»šåŠ¨ä½ç½®æ’åºå›¾ç‰‡
      dragScrollImages.sort((a, b) => a.scrollY - b.scrollY);
      console.log('æ’åºåçš„å›¾ç‰‡:', dragScrollImages.map(img => img.scrollY));

      // å¦‚æœæ²¡æœ‰åˆå§‹é€‰æ‹©æ¡†ï¼Œä½¿ç”¨å…¨å±
      if (!dragScrollInitialRect) {
        console.log('ä½¿ç”¨å…¨å±æ¨¡å¼');
        // è·å–ç¬¬ä¸€å¼ å’Œæœ€åä¸€å¼ å›¾ç‰‡çš„æ•°æ®ï¼Œæ„å»ºå®Œæ•´æˆªå›¾
        const result = await processFullPageDragCapture(dragScrollImages);
        sendDragScrollResult(result);
      } else {
        console.log('ä½¿ç”¨é€‰æ‹©æ¡†æ¨¡å¼ï¼Œå°ºå¯¸:', dragScrollInitialRect.width, 'x', dragScrollInitialRect.height);
        // ä½¿ç”¨åˆå§‹é€‰æ‹©æ¡†ä½ç½®
        const result = await processSelectedAreaDragCapture(dragScrollImages, dragScrollInitialRect);
        sendDragScrollResult(result);
      }
    } catch (error) {
      console.error('å¤„ç†æ‹–æ‹½æˆªå›¾å¤±è´¥:', error);
      showDragCaptureToast('å¤„ç†æ‹–æ‹½æˆªå›¾å¤±è´¥ï¼Œè¯·é‡è¯•');
      cleanupUserDragScrollCapture();
    }
  });
}

// å¤„ç†å…¨é¡µé¢æ‹–æ‹½æˆªå›¾
async function processFullPageDragCapture(images: Array<{dataUrl: string, scrollY: number, height: number, timestamp: number}>): Promise<string> {
  console.log('å¼€å§‹å¤„ç†å…¨é¡µé¢æ‹–æ‹½æˆªå›¾');
  return new Promise((resolve, reject) => {
    try {
      // åˆ›å»ºä¸´æ—¶Canvas
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      if (!ctx) {
        throw new Error('æ— æ³•åˆ›å»ºCanvasä¸Šä¸‹æ–‡');
      }

      // æ˜¾ç¤ºåŠ è½½æç¤º
      showDragCaptureToast('æ­£åœ¨åˆæˆå›¾ç‰‡...');

      // åŠ è½½æ‰€æœ‰å›¾åƒ
      Promise.all(images.map(img => {
        return new Promise<HTMLImageElement>((resolveImg) => {
          const image = new Image();
          image.onload = () => resolveImg(image);
          image.onerror = (err) => {
            console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', err);
            resolveImg(new Image()); // è¿”å›ç©ºå›¾ç‰‡é¿å…ä¸­æ–­
          };
          image.src = img.dataUrl;
        });
      })).then(loadedImages => {
        console.log('æ‰€æœ‰å›¾ç‰‡åŠ è½½å®Œæˆ');

        // è¿‡æ»¤æ‰æ— æ•ˆçš„å›¾ç‰‡
        const validImagePairs = loadedImages
          .map((img, index) => ({ img, data: images[index] }))
          .filter(pair => pair.img.width > 0 && pair.img.height > 0);

        if (validImagePairs.length === 0) {
          throw new Error('æ²¡æœ‰æœ‰æ•ˆçš„å›¾ç‰‡å¯ä»¥å¤„ç†');
        }

        // ç¡®å®šcanvaså¤§å° - å®½åº¦ä½¿ç”¨ç¬¬ä¸€å¼ å›¾ç‰‡çš„å®½åº¦
        const width = validImagePairs[0].img.width;

        // è®¡ç®—é«˜åº¦ - ä½¿ç”¨æœ€åä¸€å¼ å›¾ç‰‡çš„åº•éƒ¨å‡å»ç¬¬ä¸€å¼ å›¾ç‰‡çš„é¡¶éƒ¨
        const firstImageScrollY = validImagePairs[0].data.scrollY;
        const lastImageScrollY = validImagePairs[validImagePairs.length - 1].data.scrollY;
        const lastImageHeight = validImagePairs[validImagePairs.length - 1].data.height;
        const totalHeight = (lastImageScrollY - firstImageScrollY) + lastImageHeight;

        console.log('Canvaså°ºå¯¸:', width, 'x', totalHeight);

        // è®¾ç½®canvaså¤§å°
        canvas.width = width;
        canvas.height = totalHeight;

        // ä½¿ç”¨çº¯è‰²èƒŒæ™¯å¡«å……canvas
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // ç»˜åˆ¶æ¯ä¸ªå›¾åƒåˆ°å¯¹åº”ä½ç½®
        validImagePairs.forEach((pair, index) => {
          const { img, data } = pair;
          const y = data.scrollY - firstImageScrollY;
          console.log(`ç»˜åˆ¶å›¾ç‰‡ ${index}ï¼Œä½ç½®: ${y}`);
          ctx.drawImage(img, 0, y);
        });

        // è¿”å›åˆå¹¶åçš„å›¾åƒ
        const mergedImageUrl = canvas.toDataURL('image/png');
        console.log('å›¾ç‰‡åˆæˆå®Œæˆ');
        resolve(mergedImageUrl);
      }).catch(err => {
        console.error('å¤„ç†å›¾ç‰‡æ—¶å‡ºé”™:', err);
        reject(err);
      });
    } catch (error) {
      console.error('å¤„ç†å…¨é¡µé¢æ‹–æ‹½æˆªå›¾å¤±è´¥:', error);
      reject(error);
    }
  });
}

// å¤„ç†é€‰å®šåŒºåŸŸæ‹–æ‹½æˆªå›¾
async function processSelectedAreaDragCapture(images: Array<{dataUrl: string, scrollY: number, height: number, timestamp: number}>, initialRect: DOMRect): Promise<string> {
  console.log('å¼€å§‹å¤„ç†é€‰å®šåŒºåŸŸæ‹–æ‹½æˆªå›¾');
  return new Promise((resolve, reject) => {
    try {
      // åˆ›å»ºä¸´æ—¶Canvas
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      if (!ctx) {
        throw new Error('æ— æ³•åˆ›å»ºCanvasä¸Šä¸‹æ–‡');
      }

      // åŠ è½½æ‰€æœ‰å›¾åƒ
      Promise.all(images.map(img => {
        return new Promise<HTMLImageElement>((resolveImg) => {
          const image = new Image();
          image.onload = () => resolveImg(image);
          image.onerror = (err) => {
            console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', err);
            resolveImg(new Image()); // è¿”å›ç©ºå›¾ç‰‡é¿å…ä¸­æ–­
          };
          image.src = img.dataUrl;
        });
      })).then(loadedImages => {
        // è¿‡æ»¤æ‰æ— æ•ˆçš„å›¾ç‰‡
        const validImagePairs = loadedImages
          .map((img, index) => ({ img, data: images[index] }))
          .filter(pair => pair.img.width > 0 && pair.img.height > 0);

        if (validImagePairs.length === 0) {
          throw new Error('æ²¡æœ‰æœ‰æ•ˆçš„å›¾ç‰‡å¯ä»¥å¤„ç†');
        }

        // ç¡®å®šé€‰åŒºå®½åº¦
        const width = initialRect.width;

        // è®¡ç®—é«˜åº¦ - ä½¿ç”¨æœ€åä¸€å¼ å›¾ç‰‡çš„åº•éƒ¨å‡å»ç¬¬ä¸€å¼ å›¾ç‰‡çš„é¡¶éƒ¨
        const firstImageScrollY = validImagePairs[0].data.scrollY;
        const lastImageScrollY = validImagePairs[validImagePairs.length - 1].data.scrollY;
        const lastImageHeight = validImagePairs[validImagePairs.length - 1].data.height;
        const totalHeight = (lastImageScrollY - firstImageScrollY) + lastImageHeight;

        console.log('Canvaså°ºå¯¸:', width, 'x', totalHeight, 'é€‰åŒºä½ç½®:', initialRect.left);

        // è®¾ç½®canvaså¤§å°
        canvas.width = width;
        canvas.height = totalHeight;

        // ä½¿ç”¨çº¯è‰²èƒŒæ™¯å¡«å……canvas
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // è·å–è®¾å¤‡åƒç´ æ¯”ä»¥å¤„ç†é«˜åˆ†è¾¨ç‡å±å¹•
        const dpr = window.devicePixelRatio || 1;

        // ç»˜åˆ¶æ¯ä¸ªå›¾åƒçš„é€‰å®šåŒºåŸŸåˆ°å¯¹åº”ä½ç½®
        validImagePairs.forEach((pair, index) => {
          const { img, data } = pair;
          const y = data.scrollY - firstImageScrollY;

          // è®¡ç®—æˆªå›¾ä½ç½®
          const sourceX = initialRect.left * dpr;
          const sourceWidth = width * dpr;

          // å°†å›¾åƒå¯¹åº”åŒºåŸŸç»˜åˆ¶åˆ°canvasä¸Š
          try {
            ctx.drawImage(
              img,
              sourceX, 0, sourceWidth, img.height,
              0, y, width, img.height
            );
            console.log(`ç»˜åˆ¶å›¾ç‰‡ ${index}ï¼Œä½ç½®: ${y}, æºä½ç½®: ${sourceX}`);
          } catch (err) {
            console.error('ç»˜åˆ¶å›¾ç‰‡å‡ºé”™:', err, 'å›¾ç‰‡å°ºå¯¸:', img.width, 'x', img.height);
          }
        });

        // è¿”å›åˆå¹¶åçš„å›¾åƒ
        const mergedImageUrl = canvas.toDataURL('image/png');
        console.log('å›¾ç‰‡åˆæˆå®Œæˆ');
        resolve(mergedImageUrl);
      }).catch(reject);
    } catch (error) {
      console.error('å¤„ç†é€‰å®šåŒºåŸŸæ‹–æ‹½æˆªå›¾å¤±è´¥:', error);
      reject(error);
    }
  });
}

// å‘é€æ‹–æ‹½æ»šåŠ¨ç»“æœ
function sendDragScrollResult(imageUrl: string) {
  console.log('å‘é€æˆªå›¾ç»“æœåˆ°ä¾§è¾¹æ ');

  // æ˜¾ç¤ºæˆåŠŸæç¤º
  showDragCaptureToast('æˆªå›¾å·²å®Œæˆ');

  // æ‰“å¼€ä¾§è¾¹æ 
  chrome.runtime.sendMessage({
    action: 'openSidePanel'
  }, () => {
    requestAnimationFrame(() => {
      setTimeout(() => {
        chrome.runtime.sendMessage({
          action: 'addScreenshot',
          imageUrl: imageUrl,
          text: 'æ‹–æ‹½æ»šåŠ¨æˆªå›¾',
          addToInput: true
        }, (response) => {
          console.log('æˆªå›¾å‘é€ç»“æœ:', response);
        });
      }, 500);
    });
  });

  // æ¸…ç†
  cleanupUserDragScrollCapture();
}

// æ¸…ç†ç”¨æˆ·æ‹–æ‹½æ»šåŠ¨èµ„æº
function cleanupUserDragScrollCapture() {
  console.log('æ¸…ç†æ‹–æ‹½æˆªå›¾èµ„æº...');
  // é‡ç½®çŠ¶æ€
  dragScrollCapturing = false;
  dragScrollImages = [];
  dragScrollInitialRect = null;
  isDragging = false;

  // ç§»é™¤äº‹ä»¶ç›‘å¬
  document.removeEventListener('mousemove', handleDragScrollMove);
  document.removeEventListener('mouseup', handleDragScrollEnd);
  document.removeEventListener('touchmove', handleDragScrollTouchMove);
  document.removeEventListener('touchend', handleDragScrollTouchEnd);
  document.removeEventListener('keydown', handleKeyDown);

  // ç§»é™¤æ‹–æ‹½å¤„ç†å™¨
  if (dragScrollHandler) {
    dragScrollHandler.remove();
    dragScrollHandler = null;
  }

  // éšè—è¿›åº¦æŒ‡ç¤ºå™¨
  if (scrollCaptureProgress) {
    scrollCaptureProgress.style.display = 'none';
  }

  // ç§»é™¤æç¤º
  const toast = document.getElementById('ai-assistant-drag-capture-toast');
  if (toast) {
    toast.remove();
  }

  // æ¸…ç†UI
  cleanupScreenshotUI();
}

// æ˜¾ç¤ºæ‹–æ‹½æˆªå›¾æç¤º
function showDragCaptureToast(message: string) {
  // æ¸…ç†å·²æœ‰æç¤º
  const existingToast = document.getElementById('ai-assistant-drag-capture-toast');
  if (existingToast) {
    existingToast.remove();
  }

  // åˆ›å»ºæ–°æç¤º
  const toast = document.createElement('div');
  toast.id = 'ai-assistant-drag-capture-toast';
  toast.style.position = 'fixed';
  toast.style.top = '20px';
  toast.style.left = '50%';
  toast.style.transform = 'translateX(-50%)';
  toast.style.backgroundColor = 'rgba(33, 150, 243, 0.9)';
  toast.style.color = 'white';
  toast.style.padding = '12px 20px';
  toast.style.borderRadius = '8px';
  toast.style.zIndex = '2147483646';
  toast.style.fontSize = '14px';
  toast.style.fontWeight = 'bold';
  toast.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.3)';
  toast.style.textAlign = 'center';
  toast.style.maxWidth = '80%';
  toast.textContent = message;

  // æ·»åŠ åˆ°é¡µé¢
  document.body.appendChild(toast);

  // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
  requestAnimationFrame(() => {
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transition = 'opacity 0.5s ease';
      setTimeout(() => toast.remove(), 500);
    }, 3000);
  });
}

// å¼€å§‹æ‰©å±•åŒºåŸŸæˆªå›¾
function startExtendedAreaScreenshot() {
  if (!screenshotOverlay || !selectionBox || !screenshotControls) {
    createScreenshotElements();
  }

  // æ¸…ç†ä¹‹å‰çš„é€‰æ‹©æ¡†
  if (selectionBox) {
    selectionBox.style.display = 'none';
  }

  if (screenshotControls) {
    screenshotControls.style.display = 'none';
  }

  // æ˜¾ç¤ºè¦†ç›–å±‚
  if (screenshotOverlay) {
    screenshotOverlay.style.display = 'block';

    // è®¾ç½®å˜é‡
    isExtendedSelecting = true;
    extendedSelectionStartY = 0;
    extendedSelectionEndY = 0;

    // æ·»åŠ é¼ æ ‡äº‹ä»¶ç›‘å¬å™¨
    screenshotOverlay.addEventListener('mousedown', handleExtendedMouseDown);
    document.addEventListener('keydown', handleKeyDown);

    // é˜²æ­¢æ»šåŠ¨
    document.body.style.overflow = 'auto';

    // æ˜¾ç¤ºæç¤º
    showDragCaptureToast('æ‹–æ‹½é€‰æ‹©åŒºåŸŸï¼Œå¯è¶…å‡ºè§†å£è¾¹ç•Œè‡ªåŠ¨æ»šåŠ¨');
  }
}

// å¤„ç†æ‰©å±•é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶
function handleExtendedMouseDown(e: MouseEvent) {
  console.log('æ‰©å±•é€‰åŒºå¼€å§‹:', e.clientX, e.clientY);
  isExtendedSelecting = true;
  startX = e.clientX;
  startY = e.clientY;
  endX = e.clientX;
  endY = e.clientY;

  // è®°å½•æ–‡æ¡£åæ ‡ï¼ˆè€ƒè™‘æ»šåŠ¨ä½ç½®ï¼‰
  extendedSelectionStartY = e.clientY + window.scrollY;
  extendedSelectionEndY = e.clientY + window.scrollY;

  updateSelectionBox();

  if (selectionBox) {
    selectionBox.style.display = 'block';
  }

  // æ·»åŠ é¼ æ ‡ç§»åŠ¨å’Œé‡Šæ”¾äº‹ä»¶
  document.addEventListener('mousemove', handleExtendedMouseMove);
  document.addEventListener('mouseup', handleExtendedMouseUp);
}

// å¤„ç†æ‰©å±•é¼ æ ‡ç§»åŠ¨äº‹ä»¶
function handleExtendedMouseMove(e: MouseEvent) {
  if (!isExtendedSelecting) return;

  // æ›´æ–°é¼ æ ‡å½“å‰ä½ç½®
  endX = e.clientX;
  endY = e.clientY;
  extendedSelectionEndY = e.clientY + window.scrollY;

  // æ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨æ»šåŠ¨
  checkAutoScroll(e);

  // æ›´æ–°é€‰æ‹©æ¡†
  updateExtendedSelectionBox();
}

// æ£€æŸ¥å¹¶å¤„ç†è‡ªåŠ¨æ»šåŠ¨
function checkAutoScroll(e: MouseEvent) {
  const scrollThreshold = 50; // è·ç¦»è§†å£è¾¹ç¼˜å¤šå°‘åƒç´ è§¦å‘æ»šåŠ¨
  const maxScrollSpeed = 20; // æœ€å¤§æ»šåŠ¨é€Ÿåº¦

  // è®¡ç®—é¼ æ ‡è·ç¦»è§†å£è¾¹ç¼˜çš„è·ç¦»
  const distanceFromTop = e.clientY;
  const distanceFromBottom = window.innerHeight - e.clientY;

  // æ ¹æ®è·ç¦»è®¡ç®—æ»šåŠ¨é€Ÿåº¦å’Œæ–¹å‘
  if (distanceFromTop < scrollThreshold) {
    // é¼ æ ‡æ¥è¿‘é¡¶éƒ¨è¾¹ç¼˜ï¼Œå‘ä¸Šæ»šåŠ¨
    autoScrollDirection = -1;
    autoScrollSpeed = Math.min(maxScrollSpeed, (scrollThreshold - distanceFromTop) / 2);
    startAutoScroll();
  } else if (distanceFromBottom < scrollThreshold) {
    // é¼ æ ‡æ¥è¿‘åº•éƒ¨è¾¹ç¼˜ï¼Œå‘ä¸‹æ»šåŠ¨
    autoScrollDirection = 1;
    autoScrollSpeed = Math.min(maxScrollSpeed, (scrollThreshold - distanceFromBottom) / 2);
    startAutoScroll();
  } else {
    // ä¸åœ¨è¾¹ç¼˜åŒºåŸŸï¼Œåœæ­¢è‡ªåŠ¨æ»šåŠ¨
    stopAutoScroll();
  }
}

// å¼€å§‹è‡ªåŠ¨æ»šåŠ¨
function startAutoScroll() {
  if (autoScrolling) return; // å·²ç»åœ¨æ»šåŠ¨ä¸­

  autoScrolling = true;
  // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§å®šæ—¶å™¨
  if (autoScrollIntervalId !== null) {
    clearInterval(autoScrollIntervalId);
  }

  // åˆ›å»ºæ–°çš„æ»šåŠ¨å®šæ—¶å™¨
  autoScrollIntervalId = window.setInterval(() => {
    // è®¡ç®—æ–°çš„æ»šåŠ¨ä½ç½®
    const scrollAmount = autoScrollSpeed * autoScrollDirection;
    window.scrollBy(0, scrollAmount);

    // æ›´æ–°ç»“æŸä½ç½®ä»¥åæ˜ æ–°çš„æ»šåŠ¨ä½ç½®
    extendedSelectionEndY += scrollAmount;

    // æ›´æ–°é€‰æ‹©æ¡†
    updateExtendedSelectionBox();
  }, 16); // çº¦60fps
}

// åœæ­¢è‡ªåŠ¨æ»šåŠ¨
function stopAutoScroll() {
  if (!autoScrolling) return;

  autoScrolling = false;
  if (autoScrollIntervalId !== null) {
    clearInterval(autoScrollIntervalId);
    autoScrollIntervalId = null;
  }
}

// æ›´æ–°æ‰©å±•é€‰æ‹©æ¡†ä½ç½®å’Œå¤§å°
function updateExtendedSelectionBox() {
  if (!selectionBox) return;

  // è®¡ç®—è§†å£å†…çš„åæ ‡
  const viewportStartY = extendedSelectionStartY - window.scrollY;
  const viewportEndY = extendedSelectionEndY - window.scrollY;

  // è®¡ç®—é€‰æ‹©æ¡†ä½ç½®ï¼ˆå–å¯è§éƒ¨åˆ†ï¼‰
  const left = Math.min(startX, endX);
  const top = Math.min(viewportStartY, viewportEndY);
  const width = Math.abs(endX - startX);
  const height = Math.abs(viewportEndY - viewportStartY);

  // æ›´æ–°é€‰æ‹©æ¡†æ ·å¼
  selectionBox.style.left = `${left}px`;
  selectionBox.style.top = `${top}px`;
  selectionBox.style.width = `${width}px`;
  selectionBox.style.height = `${height}px`;
}

// å¤„ç†æ‰©å±•é¼ æ ‡é‡Šæ”¾äº‹ä»¶
function handleExtendedMouseUp(e: MouseEvent) {
  if (!isExtendedSelecting) return;

  console.log('æ‰©å±•é€‰åŒºç»“æŸ:', endX, endY);
  isExtendedSelecting = false;

  // åœæ­¢è‡ªåŠ¨æ»šåŠ¨
  stopAutoScroll();

  // æ£€æŸ¥é€‰æ‹©æ¡†æ˜¯å¦æœ‰è¶³å¤Ÿå¤§å°
  const minSize = 10; // æœ€å°å°ºå¯¸ï¼ˆåƒç´ ï¼‰
  const width = Math.abs(endX - startX);
  const height = Math.abs(extendedSelectionEndY - extendedSelectionStartY);

  if (width < minSize || height < minSize) {
    console.log('é€‰æ‹©æ¡†å¤ªå°ï¼Œå–æ¶ˆé€‰æ‹©');
    // é€‰æ‹©æ¡†å¤ªå°ï¼Œé‡ç½®æˆªå›¾
    if (selectionBox) selectionBox.style.display = 'none';
    cleanupExtendedScreenshot();
    return;
  }

  console.log('æ‰©å±•é€‰æ‹©æ¡†å°ºå¯¸:', width, 'x', height);
  console.log('æ–‡æ¡£åæ ‡èŒƒå›´:', extendedSelectionStartY, 'to', extendedSelectionEndY);

  // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
  showConfirmationDialog();
}

// å–æ¶ˆåŒºåŸŸæˆªå›¾

// æ•è·æ‰©å±•é€‰æ‹©åŒºåŸŸ
function captureExtendedArea() {
  // æ˜¾ç¤ºè¿›åº¦æŒ‡ç¤ºå™¨
  if (scrollCaptureProgress) {
    scrollCaptureProgress.style.display = 'flex';
    const progressText = document.getElementById('ai-assistant-scroll-progress-text');
    if (progressText) {
      progressText.textContent = 'æ­£åœ¨æ•è·æ‰©å±•åŒºåŸŸ...';
    }
  }

  // é˜²æ­¢ç”¨æˆ·äº¤äº’
  const preventInteractionOverlay = document.createElement('div');
  preventInteractionOverlay.id = 'ai-assistant-prevent-interaction';
  preventInteractionOverlay.style.position = 'fixed';
  preventInteractionOverlay.style.top = '0';
  preventInteractionOverlay.style.left = '0';
  preventInteractionOverlay.style.width = '100%';
  preventInteractionOverlay.style.height = '100%';
  preventInteractionOverlay.style.backgroundColor = 'transparent';
  preventInteractionOverlay.style.zIndex = '2147483645';
  preventInteractionOverlay.style.cursor = 'progress';
  document.body.appendChild(preventInteractionOverlay);

  // å‡†å¤‡æ•è·å‚æ•°
  const width = Math.abs(endX - startX);
  const height = Math.abs(extendedSelectionEndY - extendedSelectionStartY);
  const startScrollY = Math.min(extendedSelectionStartY, extendedSelectionEndY);
  const endScrollY = Math.max(extendedSelectionStartY, extendedSelectionEndY);
  const left = Math.min(startX, endX);

  // åˆ›å»ºç”»å¸ƒ
  const canvas = document.createElement('canvas');
  const dpr = window.devicePixelRatio || 1;
  canvas.width = width * dpr;
  canvas.height = height * dpr;
  const ctx = canvas.getContext('2d');

  if (!ctx) {
    console.error('æ— æ³•åˆ›å»ºCanvasä¸Šä¸‹æ–‡');
    cleanupExtendedScreenshot();
    return;
  }

  // ä½¿ç”¨ç™½è‰²èƒŒæ™¯å¡«å……Canvas
  ctx.fillStyle = '#FFFFFF';
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // å¼€å§‹æ•è·è¿‡ç¨‹
  captureExtendedAreaProcess(canvas, ctx, startScrollY, endScrollY, left, width);
}

// æ‰©å±•åŒºåŸŸæ•è·è¿‡ç¨‹
function captureExtendedAreaProcess(
  canvas: HTMLCanvasElement,
  ctx: CanvasRenderingContext2D,
  startScrollY: number,
  endScrollY: number,
  left: number,
  width: number
) {
  // è®¡ç®—æ€»æ»šåŠ¨é«˜åº¦
  const totalHeight = endScrollY - startScrollY;

  // å…ˆæ»šåŠ¨åˆ°åŒºåŸŸèµ·å§‹ä½ç½®
  window.scrollTo({
    top: startScrollY,
    behavior: 'smooth'
  });

  // ç­‰å¾…æ»šåŠ¨å®Œæˆ
  requestAnimationFrame(() => {
    setTimeout(() => {
      // æ”¶é›†æ‰€æœ‰éœ€è¦çš„æˆªå›¾
      collectExtendedAreaImages(canvas, ctx, startScrollY, endScrollY, left, width);
    }, 300);
  });
}

// æ”¶é›†æ‰©å±•åŒºåŸŸçš„å›¾åƒ
function collectExtendedAreaImages(
  canvas: HTMLCanvasElement,
  ctx: CanvasRenderingContext2D,
  startPos: number,
  endPos: number,
  left: number,
  width: number,
  images: Array<{dataUrl: string, scrollY: number}> = []
) {
  // æ›´æ–°è¿›åº¦
  const currentScrollY = window.scrollY;
  const progress = Math.min(100, Math.round(((currentScrollY - startPos) / (endPos - startPos)) * 100));

  if (scrollCaptureProgress) {
    const progressText = document.getElementById('ai-assistant-scroll-progress-text');
    if (progressText) {
      progressText.textContent = `æ­£åœ¨æ•è·æ‰©å±•åŒºåŸŸ: ${progress}%`;
    }
  }

  // æš‚æ—¶éšè—UIå…ƒç´ ï¼Œé¿å…å®ƒä»¬å‡ºç°åœ¨æˆªå›¾ä¸­
  hideUIElementsForCapture();

  // æ•è·å½“å‰å¯è§åŒºåŸŸ
  chrome.runtime.sendMessage({ action: 'captureVisibleTabForScroll' }, (response) => {
    // æ•è·å®Œæˆåç«‹å³æ¢å¤UIæ˜¾ç¤º
    restoreUIElementsAfterCapture();

    if (!response || !response.dataUrl) {
      console.error('æ— æ³•æ•è·å±å¹•:', response?.error || 'æœªçŸ¥é”™è¯¯');
      cleanupExtendedScreenshot();
      return;
    }

    // æ·»åŠ åˆ°å›¾ç‰‡æ•°ç»„
    images.push({
      dataUrl: response.dataUrl,
      scrollY: currentScrollY
    });

    // æ£€æŸ¥æ˜¯å¦å·²å®Œæˆå…¨éƒ¨æ•è·
    if (currentScrollY + window.innerHeight >= endPos) {
      // åˆæˆæœ€ç»ˆå›¾åƒ
      finishExtendedAreaCapture(canvas, ctx, images, startPos, endPos, left, width);
      return;
    }

    // è®¡ç®—ä¸‹ä¸€ä¸ªæ»šåŠ¨ä½ç½®
    const viewportHeight = window.innerHeight;
    // æ¯æ¬¡æ»šåŠ¨90%è§†å£é«˜åº¦ï¼Œç¡®ä¿æœ‰é‡å 
    const nextPos = Math.min(currentScrollY + viewportHeight * 0.9, endPos - viewportHeight);

    // æ»šåŠ¨åˆ°ä¸‹ä¸€ä¸ªä½ç½®
    window.scrollTo({
      top: nextPos,
      behavior: 'smooth' // ä½¿ç”¨å¹³æ»‘æ»šåŠ¨æé«˜æµç•…åº¦
    });

    // ç­‰å¾…æ»šåŠ¨å®Œæˆå¹¶ç¨³å®š
    requestAnimationFrame(() => { setTimeout(() => {
      requestAnimationFrame(() => { setTimeout(() => { collectExtendedAreaImages(canvas, ctx, startPos, endPos, left, width, images); }, 50); });
    }, 450); // ç¨å¾®å»¶é•¿ç­‰å¾…æ—¶é—´ï¼Œé€‚åº”å¹³æ»‘æ»šåŠ¨
  });
}

// éšè—UIå…ƒç´ ä»¥ä¾¿æˆªå›¾
function hideUIElementsForCapture() {
  // éšè—è¿›åº¦æŒ‡ç¤ºå™¨
  if (scrollCaptureProgress) {
    scrollCaptureProgress.dataset.prevDisplay = scrollCaptureProgress.style.display;
    scrollCaptureProgress.style.display = 'none';
  }

  // éšè—é€‰æ‹©æ¡†
  if (selectionBox) {
    selectionBox.dataset.prevDisplay = selectionBox.style.display;
    selectionBox.style.display = 'none';
  }

  // éšè—å…¶ä»–å¯èƒ½çš„UIå…ƒç´ 
  const toast = document.getElementById('ai-assistant-drag-capture-toast');
  if (toast) {
    toast.dataset.prevDisplay = toast.style.display;
    toast.style.display = 'none';
  }

  // éšè—é˜²æ­¢äº¤äº’å±‚
  const preventInteractionOverlay = document.getElementById('ai-assistant-prevent-interaction');
  if (preventInteractionOverlay) {
    preventInteractionOverlay.dataset.prevDisplay = preventInteractionOverlay.style.display;
    preventInteractionOverlay.style.display = 'none';
  }
}

// æ¢å¤UIå…ƒç´ æ˜¾ç¤º
function restoreUIElementsAfterCapture() {
  // æ¢å¤è¿›åº¦æŒ‡ç¤ºå™¨
  if (scrollCaptureProgress && scrollCaptureProgress.dataset.prevDisplay) {
    scrollCaptureProgress.style.display = scrollCaptureProgress.dataset.prevDisplay;
  }

  // æ¢å¤é€‰æ‹©æ¡†
  if (selectionBox && selectionBox.dataset.prevDisplay) {
    selectionBox.style.display = selectionBox.dataset.prevDisplay;
  }

  // æ¢å¤å…¶ä»–å¯èƒ½çš„UIå…ƒç´ 
  const toast = document.getElementById('ai-assistant-drag-capture-toast');
  if (toast && toast.dataset.prevDisplay) {
    toast.style.display = toast.dataset.prevDisplay;
  }

  // æ¢å¤é˜²æ­¢äº¤äº’å±‚
  const preventInteractionOverlay = document.getElementById('ai-assistant-prevent-interaction');
  if (preventInteractionOverlay && preventInteractionOverlay.dataset.prevDisplay) {
    preventInteractionOverlay.style.display = preventInteractionOverlay.dataset.prevDisplay;
  }
}

// å®Œæˆæ‰©å±•åŒºåŸŸæ•è·
function finishExtendedAreaCapture(
  canvas: HTMLCanvasElement,
  ctx: CanvasRenderingContext2D,
  images: Array<{dataUrl: string, scrollY: number}>,
  startScrollY: number,
  endScrollY: number,
  left: number,
  width: number
) {
  // æ›´æ–°è¿›åº¦æ˜¾ç¤º
  if (scrollCaptureProgress) {
    scrollCaptureProgress.style.display = 'flex';
    const progressText = document.getElementById('ai-assistant-scroll-progress-text');
    if (progressText) {
      progressText.textContent = 'æ­£åœ¨åˆæˆæ‰©å±•åŒºåŸŸæˆªå›¾...';
    }
  }

  // å¤„ç†å¹¶åˆæˆå›¾åƒ
  const processImages = async () => {
    try {
      // åŠ è½½æ‰€æœ‰å›¾åƒ
      const loadedImages = await Promise.all(images.map(img => {
        return new Promise<{img: HTMLImageElement, scrollY: number}>((resolve, reject) => {
          const image = new Image();
          image.onload = () => resolve({img: image, scrollY: img.scrollY});
          image.onerror = () => reject(new Error('å›¾åƒåŠ è½½å¤±è´¥'));
          image.src = img.dataUrl;
        });
      }));

      // è·å–è®¾å¤‡åƒç´ æ¯”
      const dpr = window.devicePixelRatio || 1;

      // ç­›é€‰å‡ºç¬¬ä¸€å¼ å’Œæœ€åä¸€å¼ å›¾åƒä»¥ç¡®å®šè£å‰ªåŒºåŸŸ
      const firstImage = loadedImages.sort((a, b) => a.scrollY - b.scrollY)[0];
      const lastImage = loadedImages.sort((a, b) => b.scrollY - a.scrollY)[0];

      // ç¡®å®šæµè§ˆå™¨é¡¶éƒ¨å·¥å…·æ /å¯¼èˆªæ çš„é«˜åº¦ï¼ˆé€šå¸¸æ˜¯å›ºå®šçš„ï¼‰
      // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬åŸºäºå‡è®¾è°·æ­Œæœç´¢æ ç­‰å¯¼èˆªå…ƒç´ é€šå¸¸ä½äºé¡µé¢é¡¶éƒ¨ï¼Œä¸”åœ¨æ»šåŠ¨æ—¶å›ºå®šåœ¨é¡¶éƒ¨
      // æˆ‘ä»¬å¯ä»¥é€šè¿‡æ£€æŸ¥ç¬¬ä¸€å¼ å›¾ç‰‡å’Œæœ€åä¸€å¼ å›¾ç‰‡é¡¶éƒ¨åŒºåŸŸçš„åƒç´ å·®å¼‚æ¥ä¼°è®¡è¿™ä¸ªåŒºåŸŸçš„é«˜åº¦
      let toolbarHeight = 0;
      if (loadedImages.length > 1) {
        // å‡è®¾ç¬¬ä¸€å¼ å›¾ç‰‡çš„é¡¶éƒ¨æœ‰æµè§ˆå™¨å…ƒç´ ï¼Œæœ€åä¸€å¼ å›¾ç‰‡çš„é¡¶éƒ¨å¯èƒ½å·²ç»æ»šåŠ¨åˆ°äº†ç½‘é¡µå†…å®¹
        // è¿™é‡Œæˆ‘ä»¬é€šè¿‡ç®€å•çš„å›¾åƒåˆ†ææ¥æ£€æµ‹ä¸åŒåŒºåŸŸ
        toolbarHeight = detectBrowserToolbarHeight(firstImage.img, lastImage.img, dpr);
        console.log('æ£€æµ‹åˆ°æµè§ˆå™¨å·¥å…·æ é«˜åº¦:', toolbarHeight);
      }

      // æ ¹æ®æ»šåŠ¨ä½ç½®å°†å›¾åƒåˆåˆ°Canvasä¸Šï¼ŒåŒæ—¶é¿å¼€æµè§ˆå™¨UIå…ƒç´ 
      for (const {img, scrollY} of loadedImages) {
        // è®¡ç®—å›¾åƒåœ¨Canvasä¸­çš„ä½ç½®
        const sourceX = left * dpr;
        const sourceWidth = width * dpr;
        // è°ƒæ•´æºå›¾åƒçš„Yåæ ‡ï¼Œè·³è¿‡æµè§ˆå™¨å·¥å…·æ 
        const sourceY = toolbarHeight;
        const adjustedHeight = img.height - toolbarHeight;
        const destY = (scrollY - startScrollY) * dpr;

        // ç»˜åˆ¶å›¾åƒåˆ°å¯¹åº”ä½ç½®ï¼Œé¿å¼€æµè§ˆå™¨å·¥å…·æ åŒºåŸŸ
        try {
          ctx.drawImage(
            img,
            sourceX, sourceY, sourceWidth, adjustedHeight,
            0, destY, canvas.width, adjustedHeight
          );
        } catch (err) {
          console.error('ç»˜åˆ¶å›¾ç‰‡å‡ºé”™:', err);
        }
      }

      // è£å‰ªåˆ°æŒ‡å®šé«˜åº¦
      const totalHeight = (endScrollY - startScrollY) * dpr;
      const imageData = ctx.getImageData(0, 0, canvas.width, totalHeight);

      // åˆ›å»ºæ–°Canvasä»¥é€‚åº”æ­£ç¡®çš„é«˜åº¦
      const finalCanvas = document.createElement('canvas');
      finalCanvas.width = canvas.width;
      finalCanvas.height = totalHeight;
      const finalCtx = finalCanvas.getContext('2d');

      if (!finalCtx) {
        throw new Error('æ— æ³•åˆ›å»ºæœ€ç»ˆCanvasä¸Šä¸‹æ–‡');
      }

      finalCtx.putImageData(imageData, 0, 0);

      // è·å–æœ€ç»ˆå›¾åƒURL
      const finalImageUrl = finalCanvas.toDataURL('image/png');

      // å‘é€åˆ°ä¾§è¾¹æ 
      chrome.runtime.sendMessage({
        action: 'openSidePanel'
      }, () => {
        requestAnimationFrame(() => {
          setTimeout(() => {
            chrome.runtime.sendMessage({
              action: 'addScreenshot',
              imageUrl: finalImageUrl,
              text: 'æ‰©å±•åŒºåŸŸæˆªå›¾',
              addToInput: true
            });
          }, 500);
        });
      });

      // æ˜¾ç¤ºæˆåŠŸæç¤º
      showDragCaptureToast('æ‰©å±•åŒºåŸŸæˆªå›¾å·²å®Œæˆ');

    } catch (error) {
      console.error('å¤„ç†æ‰©å±•åŒºåŸŸæˆªå›¾å¤±è´¥:', error);
      showDragCaptureToast('æˆªå›¾å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•');
    } finally {
      // æ¸…ç†èµ„æº
      cleanupExtendedScreenshot();
    }
  };

  // æ‰§è¡Œå›¾åƒå¤„ç†
  processImages();
}

// æ£€æµ‹æµè§ˆå™¨å·¥å…·æ é«˜åº¦çš„è¾…åŠ©å‡½æ•°
function detectBrowserToolbarHeight(firstImage: HTMLImageElement, lastImage: HTMLImageElement, dpr: number): number {
  try {
    // åˆ›å»ºä¸´æ—¶canvasæ¥åˆ†æå›¾ç‰‡
    const canvas1 = document.createElement('canvas');
    const canvas2 = document.createElement('canvas');
    const ctx1 = canvas1.getContext('2d', { willReadFrequently: true });
    const ctx2 = canvas2.getContext('2d', { willReadFrequently: true });

    if (!ctx1 || !ctx2) return 0;

    // è®¾ç½®å®½åº¦ä¸ºå›¾ç‰‡å®½åº¦ï¼Œé«˜åº¦ä¸ºå¯èƒ½çš„å·¥å…·æ é«˜åº¦èŒƒå›´
    const analyzeHeight = 150 * dpr; // å‡è®¾æœ€å¤§å·¥å…·æ é«˜åº¦150åƒç´ 
    canvas1.width = canvas2.width = firstImage.width;
    canvas1.height = canvas2.height = analyzeHeight;

    // ç»˜åˆ¶ä¸¤å¼ å›¾ç‰‡çš„é¡¶éƒ¨åŒºåŸŸåˆ°canvas
    ctx1.drawImage(firstImage, 0, 0);
    ctx2.drawImage(lastImage, 0, 0);

    // è·å–åƒç´ æ•°æ®
    const data1 = ctx1.getImageData(0, 0, canvas1.width, analyzeHeight).data;
    const data2 = ctx2.getImageData(0, 0, canvas2.width, analyzeHeight).data;

    // è®¡ç®—æ¯ä¸€è¡Œçš„åƒç´ å·®å¼‚
    let significantDiffFound = false;
    let toolbarHeight = 0;

    // æ¯dpråƒç´ åˆ†æä¸€æ¬¡ï¼Œæé«˜æ•ˆç‡
    for (let y = 0; y < analyzeHeight; y += dpr) {
      let rowDiff = 0;
      let pixelsAnalyzed = 0;

      // é‡‡æ ·åˆ†æè¯¥è¡Œçš„è‹¥å¹²åƒç´ ç‚¹
      for (let x = 0; x < canvas1.width; x += dpr * 10) { // æ¯10ä¸ªåƒç´ é‡‡æ ·ä¸€æ¬¡
        const i = (y * canvas1.width + x) * 4; // RGBAå››ä¸ªé€šé“
        // è®¡ç®—ä¸¤ä¸ªåƒç´ çš„é¢œè‰²å·®å¼‚
        const rDiff = Math.abs(data1[i] - data2[i]);
        const gDiff = Math.abs(data1[i+1] - data2[i+1]);
        const bDiff = Math.abs(data1[i+2] - data2[i+2]);
        const aDiff = Math.abs(data1[i+3] - data2[i+3]);

        // æ€»å·®å¼‚
        const pixelDiff = rDiff + gDiff + bDiff + aDiff;
        rowDiff += pixelDiff;
        pixelsAnalyzed++;
      }

      // è®¡ç®—å¹³å‡å·®å¼‚
      const avgDiff = pixelsAnalyzed > 0 ? rowDiff / pixelsAnalyzed : 0;

      // å¦‚æœå·®å¼‚å¤§äºé˜ˆå€¼ï¼Œè®¤ä¸ºæ˜¯ä»æµè§ˆå™¨UIå…ƒç´ è¿‡æ¸¡åˆ°ç½‘é¡µå†…å®¹çš„è¾¹ç•Œ
      if (avgDiff > 30 && !significantDiffFound) { // é˜ˆå€¼å¯ä»¥æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´
        significantDiffFound = true;
        toolbarHeight = y;
        break;
      }
    }

    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ˜æ˜¾å·®å¼‚ï¼Œè¿”å›å®‰å…¨çš„é»˜è®¤å€¼
    return significantDiffFound ? toolbarHeight : Math.min(60 * dpr, analyzeHeight / 3);
  } catch (error) {
    console.error('æ£€æµ‹æµè§ˆå™¨å·¥å…·æ é«˜åº¦æ—¶å‡ºé”™:', error);
    return 0; // å¤±è´¥æ—¶ä¸è¿›è¡Œè£å‰ª
  }
}

// æ¸…ç†æ‰©å±•æˆªå›¾èµ„æº
function cleanupExtendedScreenshot() {
  // åœæ­¢è‡ªåŠ¨æ»šåŠ¨
  stopAutoScroll();

  // é‡ç½®çŠ¶æ€
  isExtendedSelecting = false;

  // æ¢å¤æ»šåŠ¨åˆ°åˆç†ä½ç½®
  window.scrollTo({
    top: Math.min(extendedSelectionStartY, extendedSelectionEndY),
    behavior: 'smooth'
  });

  // éšè—è¿›åº¦æŒ‡ç¤ºå™¨
  if (scrollCaptureProgress) {
    scrollCaptureProgress.style.display = 'none';
  }

  // ç§»é™¤äº¤äº’é˜»æ­¢å±‚
  const preventInteractionOverlay = document.getElementById('ai-assistant-prevent-interaction');
  if (preventInteractionOverlay) {
    preventInteractionOverlay.remove();
  }

  // å®Œå…¨æ¸…ç†UI
  cleanupScreenshotUI();
}

// å¤„ç†é”®ç›˜æŒ‰é”®äº‹ä»¶ï¼Œç”¨äºå–æ¶ˆæˆªå›¾
function handleKeyDown(e: KeyboardEvent) {
  // ESCé”®å–æ¶ˆæˆªå›¾
  if (e.key === 'Escape') {
    console.log('ESCæŒ‰é”®å–æ¶ˆæˆªå›¾');

    // å–æ¶ˆæ‰©å±•åŒºåŸŸæˆªå›¾ï¼ˆå¦‚æœæ­£åœ¨è¿›è¡Œï¼‰
    if (isExtendedSelecting) {
      cleanupExtendedScreenshot();
    }

    // å–æ¶ˆåŒºåŸŸé€‰æ‹©æˆªå›¾ï¼ˆå¦‚æœæ­£åœ¨è¿›è¡Œï¼‰
    if (isSelecting) {
      cancelAreaScreenshot();
    }

    // å–æ¶ˆæ‹–æ‹½æ»šåŠ¨æˆªå›¾ï¼ˆå¦‚æœæ­£åœ¨è¿›è¡Œï¼‰
    if (dragScrollCapturing) {
      cleanupUserDragScrollCapture();
    }

    // ç§»é™¤é”®ç›˜äº‹ä»¶ç›‘å¬
    document.removeEventListener('keydown', handleKeyDown);
  }
}
